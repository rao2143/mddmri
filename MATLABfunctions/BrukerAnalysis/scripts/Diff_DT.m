clear allwd = cd;DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/opt/topspin2/data/DT/nmr';% ExpNam = {'qMASopt'}; expno = 171; %expno = 33:40; expno = 171:180;% basl = [.02 .35 .65 .98]; lb = 10; si = 16*1024;% ll = [6563        6903        9489]';% ul = [6780        7056        9693]';% % ExpNam = {'qMASopt2'}; expno = 9;% basl = [.02 .3 .7 .98]; lb = 10; si = 16*1024;% ll = [6540 6926 9508]';% ul = [6773 7084 9679]';% DataDir = '/Users/daniel/NMRdata/AVII500/stefanie/';% ExpNam = {'qMASopt2'}; expno = 8:9;% basl = [.02 .38 .45 .51 .63 .98]; lb = 10; si = 16*1024; phc0 = 190; phc1 = 1;ExpNam = {'AOT_1H2H'}; expno = 38;basl = [.02 .15 .4 .6 .85 .98];cd(DataDir)AutoPhase = 0;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .05;td1start = 3;signal = 'area'; signal = 'intensity';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_qMASdt','SE_qMASdt'})) == 1        Spec2Dtd1        if AutoPhaseAll            AutoPhasetd1        end        PeakPick        gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end%%        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        elseif any(strcmp(NMRacqus.probhd,{'5 mm Diff25 1H Z-GRD H7979/10'})) == 1            Gmax = 9.6;        end        fid = fopen([num2str(expno(nexp)) '/rx.txt']);        ramp.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry.txt']);        ramp.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz.txt']);        ramp.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/riso.txt']);        ramp.iso = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASx.txt']);        Gmod.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASy.txt']);        Gmod.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASz.txt']);        Gmod.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASr.txt']);        Gmod.r = fscanf(fid,'%f');        fclose(fid);        G.x = ramp.x*Gmax.*NMRacqus.cnst1/100;        G.y = ramp.y*Gmax.*NMRacqus.cnst2/100;        G.z = ramp.z*Gmax.*NMRacqus.cnst3/100;        G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);        G.iso = ramp.iso*Gmax.*NMRacqus.cnst3/100;        G.max = max([G.iso; G.r]);        Gnorm.x = G.x./G.r;        Gnorm.y = G.y./G.r;        Gnorm.z = G.z./G.r;                Ndt = length(Gmod.x);        tau = NMRacqus.d3;        dt = tau/Ndt;        F.r = cumsum(Gmod.r*dt);        b.r = sum(F.r.^2*dt);                F.x = cumsum(Gmod.x*dt);        F.y = cumsum(Gmod.y*dt);        F.z = cumsum(Gmod.z*dt);        F.iso = sqrt(F.x.^2 + F.y.^2 + F.z.^2);        b.iso = sum(F.iso.^2*dt);        b = 2*b.iso*gamma^2*(G.r + G.iso).^2;        figure(1), clf        subplot(2,2,1)        plot(1:td1,b)        subplot(2,2,2)        plot(1:length(Gmod.x),Gmod.x,'r-',1:length(Gmod.x),Gmod.y,'g-',...            1:length(Gmod.x),Gmod.z,'b-',1:length(Gmod.x),Gmod.r,'k-')        subplot(2,2,3)        plot(1:td1,Gnorm.x,'ro',1:td1,Gnorm.y,'go',1:td1,Gnorm.z,'bo')                Gdir = Gnorm.x + i*Gnorm.y;        subplot(2,2,4)        plot(real(Gdir),imag(Gdir),'bo')                              [X,Y] = fSchmidt(Gnorm.x,Gnorm.y,Gnorm.z);        latitude.theta = pi/180*[30:30:150 179];        latitude.phi = linspace(0,2*pi,100);        [latitude.phi,latitude.theta] = ndgrid(latitude.phi,latitude.theta);        latitude.z = cos(latitude.theta);        latitude.x = sin(latitude.theta).*cos(latitude.phi);        latitude.y = sin(latitude.theta).*sin(latitude.phi);        [latitude.X,latitude.Y] = fSchmidt(latitude.x,latitude.y,latitude.z);        longitude.theta = pi/180*linspace(30,180,100);        longitude.phi = pi/180*[30:30:360];        [longitude.theta,longitude.phi] = ndgrid(longitude.theta,longitude.phi);        longitude.z = cos(longitude.theta);        longitude.x = sin(longitude.theta).*cos(longitude.phi);        longitude.y = sin(longitude.theta).*sin(longitude.phi);        [longitude.X,longitude.Y] = fSchmidt(longitude.x,longitude.y,longitude.z);                subplot(2,2,4)                plot(X,Y,'ko')        hold on        plot(latitude.X,latitude.Y,'b-')        plot(longitude.X,longitude.Y,'b-')        axis equal                       PP.X = b;                eval(['save ' num2str(expno(nexp)) '/PeakDat PP'])%%                Xdat = b;        indx = find(isnan(Gnorm.x) == 1);        Ndir = indx(2) - indx(1);        DirDat = cell(Ndir,1);        Dnocalib = zeros(Ndir,1);        %PlotInterm = 1;            for ndir = 1:Ndir            fitpoints = ndir - Ndir + (Ndir:Ndir:NMRacqu2s.td);            fitpoints = fitpoints(1:length(fitpoints));            %ExpFit            GammaFit            DirDat{ndir,1} = FitDat;            Dnocalib(ndir) = FitDat.R(1);        end        %%        figure(1), clf        plot(1:Ndir,Dnocalib,'o')        eval(['save ' num2str(expno(nexp)) '/Dnocalib Dnocalib'])        %%        fs = 20;        lw = 1;                figure(1), clf        axes('position',[-.01 .15 .65 .35],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .1*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        hold on        plot(PP.peakppm(td1start,:),PP.Ipeak(td1start,:),'bo','LineWidth',lw)        h = plot(PP.ppm,-1*ylim(1)+50*PP.Ispec,'k','LineWidth',.25*lw);        set(h,'Color',.5*[1 1 1])        plot(PP.ppm,PP.Ispec,'k','LineWidth',1.5*lw)        dleft = (1-.55)/Npeaks;        width = .9*dleft;        height = .3;        left = 1-width;        bottom = .6;        if Npeaks == 1, width = .8*1/2; end        Dnocalib = zeros(Ndir,Npeaks);        for npeak = 1:Npeaks            axes('position',[left bottom width height],'FontSize',fs*.8)            semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo')            hold on            semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'b-','LineWidth',lw)            axis('tight')            ylim = get(gca,'YLim');            ylim = 1*[1e-3 1.2];            xlim = get(gca,'XLim');            xlim = .1*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,'YTick',[1e-3 1e-2 1e-1 1],...                'TickLength',.02*[1 1],'TickDir','out','Box','off','YMinorTick','on','LineWidth',1.5*lw)                        for ndir = 1:Ndir                FitDat = DirDat{ndir,1};                semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo')                semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'b-','LineWidth',lw)                Dnocalib(ndir,npeak) = FitDat.R(npeak);            end            ndir = 1;            FitDat = DirDat{ndir,1};            semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'ko')            semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k-','LineWidth',2*lw)                                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                [num2str(FitDat.R(npeak),3) ' m^2s^-^1']},'FontSize',fs*.5)            left = left-dleft;            if npeak < Npeaks                set(gca,'XTick',[],'YTick',[])            end                    end                axes('position',[.8 .15 .2 .35],'FontSize',fs*.8)        semilogy(1:Ndir,Dnocalib,'o')        axis tight        xlim = get(gca,'XLim'); ylim = get(gca,'YLim');        xlim = .1*diff(xlim)*[-1 1] + xlim;        ylim = [5e-11 3e-9];        set(gca,'XLim',xlim,'YLim',ylim,'YTick',[1e-10 1e-9],'TickLength',.02*[1 1],'TickDir','out',...            'Box','off','YMinorTick','on','LineWidth',1.5*lw)               xlabel('direction','FontSize',fs)        ylabel('D / m^2s^-^1','FontSize',fs)                axes('position',[.23 .6 .2*[1 11/8]],'FontSize',fs*.8)        plot(X,Y,'ko')        hold on        plot(latitude.X,latitude.Y,'b-')        plot(longitude.X,longitude.Y,'b-')        axis tight equal off        axes('position',[.01 .6 .2 .3],'FontSize',fs*.8)        h = plot(1:length(Gmod.x),Gmod.x,'r-',1:length(Gmod.x),Gmod.y,'g-',...            1:length(Gmod.x),Gmod.z,'b-',1:length(Gmod.x),Gmod.r,'k-');        set(h,'LineWidth',lw)        axis tight off        title([num2str(G.max,3) 'T/m 2*' num2str(1e3*NMRacqus.d3,3) 'ms '],'FontSize',fs*.75)        xlim = get(gca,'XLim'); ylim = get(gca,'YLim');        xlim = .02*diff(xlim)*[-1 1] + xlim;        ylim = .02*diff(ylim)*[-1 1] + ylim;        set(gca,'XLim',xlim,'YLim',ylim)                       eval(['save ' num2str(expno(nexp)) '/FitDat FitDat'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])        %%    endend