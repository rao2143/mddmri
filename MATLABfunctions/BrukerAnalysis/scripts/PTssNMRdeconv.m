clear allwd = cd;cd('/Users/daniel/NMRdata/AVII500/Nils_C8G2/')ExpNam = {'C8G2_RH96_3'};expno = 85;offset = [      6.1700e+01   7.2900e+01   7.4200e+01   7.3700e+01   7.0400e+01   1.0340e+02      6.1900e+01   7.5600e+01   7.8900e+01   7.7200e+01   7.4000e+01   1.0120e+02   7.0900e+01   3.0300e+01   2.6600e+01   3.0200e+01   3.0000e+01   3.2500e+01   2.3200e+01   1.4400e+01]';%offset = [14.4];width = .3*ones(size(offset));ampl1 = 3e5*ones(size(offset));ampl2 = .5*ampl1;ppmlimits = [min(offset) max(offset)] + 10*max(width)*[-1 1];NMC = 0;fontsize = 20;linewidth = 1;for ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    for nexp = 1:length(expno)        DP = load([num2str(expno(nexp)) '/SpecDat.mat']);        CP = load([num2str(expno(nexp)+1) '/SpecDat.mat']);        INEPT = load([num2str(expno(nexp)+2) '/SpecDat.mat']);        ppm = INEPT.Spec.ppm;        I = INEPT.Spec.I;        fitpoints = [];        for nppm = 1:2:length(ppmlimits)-1            fitpoints = [fitpoints; find([ppm>ppmlimits(nppm) & ppm<ppmlimits(nppm+1)])];        end        %figure(1), clf, plot(ppm,I,ppm(fitpoints),I(fitpoints),'.r'), axis([min(ppm) max(ppm) max(I(fitpoints))*[-.1 1.1]]),     set(gca,'XDir','reverse','YTick',[],'LineWidth',linewidth), return        Xin = [ppm(fitpoints); ppm(fitpoints)];        Yin = [INEPT.Spec.I(fitpoints); CP.Spec.I(fitpoints)];                %figure(1), clf, plot(Xin,Yin,'-'), return        Para.si = length(fitpoints);        Para.Npeaks = length(offset);        Para.Ntd1 = 2;                Pin = [offset width ampl1 ampl2]; Funam = 'fSumLorentz2D';        LB = [ offset-.1 .2*width 10*ones(1,2*length(offset))];        UB = [ offset+.1 5*width 1e7*ones(1,2*length(offset))];        Pout = Pin; Pnorm.Y = mean(Yin); Pnorm.X = mean(Xin); Pnorm.P = Pin;         Pout = Pnorm.P.*lsqcurvefit(Funam,Pin./Pnorm.P,Xin/Pnorm.X,Yin/Pnorm.Y,LB./Pnorm.P,UB./Pnorm.P,[],Para,Pnorm);        %Pout = P.Pnorm.*lsqcurvefit(Funam,Pin./P.Pnorm,Xin/P.Xnorm,Yin/P.Ynorm,[],[],[],P);        Ycalc = feval(Funam,Pout,Xin,Para); error = Yin - Ycalc;               %figure(1), clf, plot(Xin,Yin,'-',Xin,Ycalc,'r-'), return                Xin = Xin(1:Para.si,1);        Yin = reshape(Yin,Para.si,Para.Ntd1);        Ycalc = reshape(Ycalc,Para.si,Para.Ntd1);        %figure(1), clf, plot(Xin,Yin,'-',Xin,Ycalc,'r-'), return        Pout = reshape(Pout,Para.Npeaks,numel(Pout)/Para.Npeaks);        offset = Pout(:,1)';        width = Pout(:,2)';        amplArray = Pout(:,2+(1:Para.Ntd1))';        ampl1 = amplArray(1,:);        ampl2 = amplArray(2,:);        relamplArray = amplArray/sum(sum(amplArray));        figure(1), clf        axes('FontSize',fontsize,'LineWidth',linewidth)        plot(CP.Spec.ppm,CP.Spec.I,'b','LineWidth',2)        hold on        plot(INEPT.Spec.ppm,INEPT.Spec.I,'r','LineWidth',1)        plot(Xin,Ycalc,'k','LineWidth',.5)        xlabel('\delta(^{13}C) / ppm','FontSize',fontsize)        set(gca,'XDir','reverse','YTick',[],'LineWidth',linewidth)                %         % %         if NMC > 0%             Yin1 = Yin;%             noiselevel = std(error);%             Poutarray = zeros(NMC,length(Pin));%             for nMC = 1:10%                 Yin = Yin1 + 2*noiselevel*randn(size(Yin));%                 Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,[],Pnorm,Xnorm,Ynorm);%                 Poutarray(nMC,:) = Pout;%                 ampl = Pout(Npeak+1:2*Npeak);%                 relamplarray(nMC,:) = ampl/sum(ampl);%             end%             FitDat.Npeak = length(Pout)/3;%             FitDat.T2 = mean(Poutarray(:,1:Npeak),1);%             FitDat.ampl = mean(Poutarray(:,Npeak+1:2*Npeak),1);%             FitDat.offset = mean(Poutarray(:,2*Npeak+1:3*Npeak),1);%             FitDat.T2std = std(Poutarray(:,1:Npeak),1);%             FitDat.amplstd = std(Poutarray(:,Npeak+1:2*Npeak),1);%             FitDat.offsetstd = std(Poutarray(:,2*Npeak+1:3*Npeak),1);% %             save FitDat FitDat%             ampl = FitDat.ampl;%             relampl = mean(relamplarray,1);%             relamplstd = std(relamplarray,1);%         end        for nppm = 1:2:length(ppmlimits)-1            ppmindex = find([ppm>ppmlimits(nppm) & ppm<ppmlimits(nppm+1)]);            Pin = [offset width ampl1 ampl2];            Icalc = fSumLorentz(Pin,ppm(ppmindex),Para);            Icalc = real(Icalc);            Icalc = reshape(Icalc,length(ppmindex),Para.Ntd1);            plot(ppm(ppmindex),Icalc,'r-','LineWidth',2)        end%%        for npeak = 1:length(ampl1)            ppmindex = find([ppm>offset(npeak)-width(npeak) & ppm<offset(npeak)+width(npeak)]);            Pin = [offset(npeak) width(npeak) ampl1(npeak) ampl2(npeak)];            Icalc = fSumLorentz(Pin,ppm(ppmindex),1,1,1);            Icalc = real(Icalc);            TextString = [{[num2str(offset(npeak),3) 'ppm']};                {[num2str(100*relampl(npeak),2) '%']}];            if NMC > 0                TextString = [{[num2str(offset(npeak),3) 'ppm']};                    {[num2str(100*relampl(npeak),2) '\pm' num2str(100*relamplstd(npeak),1) '%']}];            end            text(offset(npeak),max(Icalc),TextString,...                'FontSize',6,'HorizontalAlignment','center','VerticalAlignment','bottom')        end        %axis([min(ppm) max(ppm) max(max(max(Ycalc)))*[-.2 1.1]]), grid        axis([min(ppmlimits) max(ppmlimits) max(max(max(Ycalc)))*[-.2 1.1]]), grid        plot(Xin,error/max(abs(error))*max(Ycalc)*.1 - max(Ycalc)*.1,'k'), grid        hold off        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*linewidth,'Box','off','TickDir','out','Ycolor',[1 1 1])        %%        figure(2), clf        plot(1:Para.Npeaks,ampl1,'r-o')        hold on        plot(1:Para.Npeaks,ampl2,'b-o')        %%        Inorm = ampl(length(ampl));        ppmnorm = offset(length(ampl));    end    cd ..endcd(wd)