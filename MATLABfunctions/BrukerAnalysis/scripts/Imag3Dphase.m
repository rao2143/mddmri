clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT';%DataDir = '/Users/daniel/NMRdata/AVII500/';%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/opt/nmrdata/daniel';cd(DataDir)ExpNam = {'MIC5_10mm_setup'}; expno = 102;%ExpNam = {'Norah'};% ExpNam = {'DTI_HHnerve'};% ExpNam = {'HHnerve4'};% ExpNam = {'HHnerve3'};% ExpNam = {'HHnerve2'};%ExpNam = {'qMASdtirare2d_test'; 'qMASopt'; 'pgse4_test'; 'isoanisocorr_qMASopt'; 'RARE3Dtest'};%ExpNam = {'DiffVACSY'};%ExpNam = {'qVAS_Starch'};%ExpNam = {'AOToct'}; expno = 114;%ExpNam = {'AOToct_temp4'}; expno = [4 14 24 34]; expno = 34;%ExpNam = {'AOToct_temp5'};%ExpNam = {'AOToct_temp6'}; expno = 14:10:264;%ExpNam = {'AOToct2'}; expno = 15;%ExpNam = {'AOToct_temp9'}; expno = 17:10:137;%GetExpnamslb = .2e-4;%si = 128;for ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    fontsize = 15;    for nexp = 1:length(expno)        ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if all([strcmp('DT_imge3d',NMRacqus.pulprog); exist([num2str(expno(nexp)) '/ser'])])            eval(['load ' num2str(expno(nexp)) '/NMRacqu2s'])            res = unixtc([num2str(expno(nexp)) '/acqu3s'],[num2str(expno(nexp)) '/acqu3sconv']);            td = 256*ceil(NMRacqus.td/256);            tdim.z = td/2;            tdim.y = NMRacqu2s.td;            tdim.x = jcampdx([num2str(expno(nexp)) '/acqu3sconv'],'TD');;            Slength = tdim.z*tdim.y*tdim.x;    %         if exist('si') == 0, si = tdim.z; end    %         if exist('siy') == 0, siy = tdim.y; end    %         if exist('six') == 0, six = tdim.x; end            si = tdim.z;            siy = tdim.y;            six = tdim.x;            nudim.z = si;            nudim.y = siy;            nudim.x = six;            dw = 1/NMRacqus.sw_h/2;            t = 2*dw*(0:(tdim.z-1))';            t = t-t(tdim.z/2+1);            gamma = 26.75e7;            if strcmp(NMRacqus.nuc1,'2H') == 1                gamma = 4.1065e7;            elseif strcmp(NMRacqus.nuc1,'23Na') == 1                gamma = 7.0761e7;            end            Gmax = 3;            if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                    '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1                Gmax = 0.5;            end            g.z = NMRacqus.cnst13*Gmax/100;            k.z = gamma*g.z*t/2/pi;            g.x = linspace(-1,1,tdim.x+1)'*Gmax*NMRacqus.cnst21/100; g.x = g.x(1:tdim.x);            g.y = linspace(-1,1,tdim.y+1)'*Gmax*NMRacqus.cnst22/100; g.y = g.y(1:tdim.y);            t_phasenc = NMRacqus.d33 + NMRacqus.d32;            if any([NMRacqus.year<2008 ...            all([NMRacqus.year==2008  NMRacqus.month<6]) == 1 ...            all([NMRacqus.year==2008  NMRacqus.month==6 NMRacqus.day<10]) == 1 ...            all([NMRacqus.year==2008  NMRacqus.month==6 NMRacqus.day==10 NMRacqus.hour<19]) == 1]) == 1                t_phasenc = NMRacqus.d13 + NMRacqus.d12;            end            if any([NMRacqus.year<2007 ...            all([NMRacqus.year==2007  NMRacqus.month<9]) == 1 ...            all([NMRacqus.year==2007  NMRacqus.month==9 NMRacqus.day<10]) == 1 ...            all([NMRacqus.year==2007  NMRacqus.month==9 NMRacqus.day==10 NMRacqus.hour<19]) == 1]) == 1                t_phasenc = .5*NMRacqus.aq + NMRacqus.d2;                g.x = linspace(-1,1,tdim.x+1)'*Gmax*NMRacqus.cnst11/100; g.x = g.x(1:tdim.x);                g.y = linspace(-1,1,tdim.y+1)'*Gmax*NMRacqus.cnst12/100; g.y = g.y(1:tdim.y);            end            k.x = gamma*g.x'*t_phasenc/2/pi;            k.y = gamma*g.y'*t_phasenc/2/pi;            r.x = .5/(k.x(2)-k.x(1))*linspace(-1,1,nudim.x+1)'; r.x = r.x(1:nudim.x);            r.y = .5/(k.y(2)-k.y(1))*linspace(-1,1,nudim.y+1)'; r.y = r.y(1:nudim.y);            r.z = .5/(k.z(2)-k.z(1))*linspace(-1,1,nudim.z+1)'; r.z = r.z(1:nudim.z);            lbfunz = exp(-(lb*pi*k.z).^2);            lbfunx = exp(-(lb*pi*k.x).^2);            %figure(1), clf, plot(k.z,lbfunz,'o',k.x,lbfunx,'s'), return            fid = fopen([num2str(expno(nexp)) '/ser'],'r','ieee-le');            S = fread(fid,[2,Slength],'long');            S = S(1,:) + i*S(2,:);            fclose(fid);            %figure(1), clf, plot(1:Slength,real(S),1:Slength,imag(S)), return            S = reshape(S,tdim.z,tdim.y,tdim.x);            S = S - mean(mean(mean(S([1:round(.1*tdim.z) round(.9*tdim.z):tdim.z],:,:))));            Stemp = S(:,tdim.y/2+1,tdim.x/2+1);            %figure(1), clf, plot(1:tdim.z,real(Stemp)), return            grpdlycount = (1:(td/2))'/(td/2) - floor(td/2/2);            zeroshiftfun = exp(-i*(NMRacqus.grpdly*2*pi*grpdlycount));            zeroshiftfun = flipdim(zeroshiftfun,1);            zeroshiftfun = fftshift(zeroshiftfun,1);            Stemp = fft(Stemp,td/2,1);            Stemp = zeroshiftfun.*Stemp;            Stemp = ifft(Stemp,td/2,1);            %figure(1), clf, plot(t,real(Stemp)), return            Stemp = lbfunz.*Stemp;            %figure(1), clf, plot(k.z,real(Stemp),k.z,lbfunz*max(real(Stemp))), return            index = 1:td/2;            if si<td/2                index = .5*(td/2-si) + (1:si);                Stemp = Stemp(index);                k.z = k.z(index);                lbfunz = lbfunz(index);                %figure(1), clf, plot(k.z,real(Stemp),k.z,lbfunz*max(real(Stemp))), return            end            Itemp = fftshift(fft(Stemp,si));            %figure(1), clf, plot(abs(Itemp)), return            [zeroshiftfun,karray.y,karray.x] = ndgrid(zeroshiftfun,k.y,k.x);            [karray.z,karray.y,karray.x] = ndgrid(k.z,k.y,k.x);            lbfun1 = exp(-lb.^2*pi.^2*(karray.z.^2 + karray.y.^2 + karray.x.^2));            %figure(1), clf, plot(real(squeeze(S(:,siy/2+1,six/2+1)))), return            Stemp = fft(S,td/2,1);            Stemp = zeroshiftfun.*Stemp;            Stemp = ifft(Stemp,td/2,1);            %figure(1), clf, plot(real(squeeze(Stemp(:,siy/2+1,six/2+1)))), return            Stemp = Stemp(index,:,:);            Stemp = Stemp.*lbfun1;            %figure(1), clf, plot(real(squeeze(Stemp(:,siy/2+1,six/2+1)))), return            Itemp = fftshift(fft(ifftshift(Stemp,1),[],1),1);            Itemp = fftshift(fft(ifftshift(Itemp,2),[],2),2);            I = fftshift(fft(ifftshift(Itemp,3),[],3),3);            %I = abs(I);            Imax = abs(I);            Imax(nudim.z/2+(-2:4),nudim.y/2+(0:2),nudim.x/2+(0:2)) = 0;            Imax = max(reshape(Imax,numel(Imax),1));            maxz = max(r.z)*1e3;            maxx = max(r.x)*1e3;            nx = nudim.x/2+1;            ny = nudim.y/2+1;            nz = nudim.z/2+1;            [Iplot.r,Iplot.g,Iplot.b] = fphase2rgb(angle(I));            Iplot.r = Iplot.r.*abs(I)/Imax;            Iplot.g = Iplot.g.*abs(I)/Imax;            Iplot.b = Iplot.b.*abs(I)/Imax;                        figure(1), clf                       axes('position',[.07 .1 .2 .9],'FontSize',fontsize)            C = zeros(si,six,3);            C(:,:,1) = squeeze(Iplot.r(:,ny,:));            C(:,:,2) = squeeze(Iplot.g(:,ny,:));            C(:,:,3) = squeeze(Iplot.b(:,ny,:));            image(r.x*1e3,r.z*1e3,C)            set(gca,'YDir','normal')            axis equal, axis tight            ylabel('\itz\rm / mm'), xlabel('\itx\rm / mm')            axes('position',[.28 .1 .2 .9],'FontSize',fontsize)            C = zeros(si,siy,3);            C(:,:,1) = squeeze(Iplot.r(:,:,nx));            C(:,:,2) = squeeze(Iplot.g(:,:,nx));            C(:,:,3) = squeeze(Iplot.b(:,:,nx));            image(r.y*1e3,r.z*1e3,C)            set(gca,'YDir','normal','YTick',[])            axis equal, axis tight            xlabel('\ity\rm / mm')            Nslices = 4^2;            slices = round(nudim.z*linspace(0,1,Nslices+2)); slices([1 Nslices+2]) = [];            width = .5/sqrt(Nslices);            height = 11/8.5*.5/sqrt(Nslices);            nslice = 1;            for county = 1:sqrt(Nslices)                for countx = 1:sqrt(Nslices)                    axes('position',[1-countx*width .2+(county-1)*height 1.01*width 1.01*height])                    nz = slices(nslice);                    C = zeros(siy,six,3);                    C(:,:,1) = squeeze(Iplot.r(nz,:,:));                    C(:,:,2) = squeeze(Iplot.g(nz,:,:));                    C(:,:,3) = squeeze(Iplot.b(nz,:,:));                    image(r.x*1e3,r.y*1e3,C)                    set(gca,'YDir','normal','YTick',[])                    axis tight, axis off                    nslice = nslice+1;                end            end                        delete([num2str(expno(nexp)) '/ReportFig.*'])            delete([num2str(expno(nexp)) '/acqu*sconv'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -depsc'])            eval(['save ' num2str(expno(nexp)) '/ImageDat I r'])                    end    end    cd ..endcd(wd)