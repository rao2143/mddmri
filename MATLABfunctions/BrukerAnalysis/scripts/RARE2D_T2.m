clear allwd = cd;%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/Users/daniel/Dropbox';DataDir = '/Users/daniel/NMRdata/AVII500/DT';%ExpNam = {'DTItest'}; expno = 119;%ExpNam = {'NafionDTI'};%ExpNam = {'DTI_HHnerve'}; %expno = 414;%ExpNam = {'MIC5_10mm_setup'};%ExpNam = {'HHnerve3'};%ExpNam = {'HHnerve4'};%ExpNam = {'isoaniso_test'};%ExpNam = {'uFA_RARE'}; expno = 74;%ExpNam = {'DiffVACSY'}; expno = 54;%ExpNam = {'AOToct2'};%ExpNam = {'MIC5_2H_setup'}; expno = 16;%ExpNam = {'AOToct8'};%ExpNam = {'AOToct9'};ExpNam = {'C14E5_6'};lb = 150e-6;si = 32; si1 = si;td1start = 2;td1end = 32;thresh = .2;MakeFit = 1;fontsize = 15;cd(DataDir)%GetExpnamsfor ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    for nexp = 1:length(expno)        ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if any(strcmp(NMRacqus.pulprog,{'DT_t2rare2d'})) == 1                        RARE2Dtd1                        Imax = abs(Itd1);            Imax(nudim.i/2+(0:2),nudim.j/2+(0:2),:) = 0;            Imax(:,:,1:(td1start-1)) = 0;            Imax = max(reshape(Imax,numel(Imax),1));            %tau = NMRacqus.vd + 8*NMRacqus.d32 + 2*NMRacqus.p12*1e-6;            tau = NMRacqus.vd;            Images.S0 = zeros(nudim.i,nudim.j);            Images.R2 = zeros(nudim.i,nudim.j);            if MakeFit                for nj = 1:nudim.j                               for ni = 1:nudim.i                        index.fit = td1start:min([td1 td1end]);                        Yin = abs(squeeze(Itd1(ni,nj,index.fit)));                        Xin = tau(index.fit);                        Pin = [Yin(1) 10]; Funam = 'fexp';                        LB = [0 0]; UB = [2*Yin(1) 10];                        if Yin(1)>Imax*thresh                            Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;                             [Pout,resnorm,residual,exitflag,output] = lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,[],Pnorm,Xnorm,Ynorm); Pout = Pout.*Pnorm;                            Ycalc = feval(Funam,Pout,Xin,ones(size(Pin)),1,1); error = Yin - Ycalc;                            %return                            %figure(2), clf, plot(index.fit,Yin,'o',index.fit,Ycalc,'-'), title(num2str(nj)); pause(.1)                            Images.S0(ni,nj) = Pout(1);                            Images.R2(ni,nj) = Pout(2);                        end                                      end                end                eval(['save ' num2str(expno(nexp)) '/Images Images r'])            else                eval(['load ' num2str(expno(nexp)) '/Images'])            end                       %%            rmax.i = max(r.i)*1e3;            rmax.j = max(r.j)*1e3;                        %R2max = max(max(Images.R2));            R2max = 1.5*sum(sum((Images.S0.*Images.R2),1),2)/sum(sum((Images.S0),1),2);            %R2max = 40;                        figure(3), clf            colormap('hot')            axes('position',[.1 .1 .4 .8])            Iplot = squeeze(Images.S0(:,:)/Imax);            clim = [0 1];            imagesc(r.i*1e3,r.j*1e3,Iplot',clim)            set(gca,'YDir','normal')            axis equal, axis tight            xlabel('read / mm'), ylabel('phase / mm')            title('S0')            colorbar            axes('position',[.6 .1 .4 .8])            Iplot = squeeze(Images.R2(:,:));            clim = [0 R2max];            imagesc(r.i*1e3,r.j*1e3,Iplot',clim)            set(gca,'YDir','normal')            axis equal, axis tight            xlabel('read / mm'), ylabel('phase / mm')            title(['R2 / s^-^1'])            colorbar%%            delete([num2str(expno(nexp)) '/ReportFig*'])            delete([num2str(expno(nexp)) '/acqu*sconv'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            set(gcf, 'PaperPosition', [0 0 11 8.5],'PaperSize', [11 8.5]);             eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -dpdf'])        end    end    cd ..endcd(wd)