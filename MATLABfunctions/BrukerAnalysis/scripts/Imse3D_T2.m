clear allwd = cd;DataDir = '/Users/daniel/NMRdata/AVII500/DT';%DataDir = '/Users/daniel/NMRdata/AVII500/';%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/Users/daniel/Dropbox';cd(DataDir)%ExpNam = {'imse3d_test'}; expno = [6 23];%ExpNam = {'AOToct3'}; expno = [9];%ExpNam = {'AOToct4'}; expno = 13;%ExpNam = {'Tissue_qVAS'}; expno = 11;%ExpNam = {'AOToct5'}; expno = 13;%ExpNam = {'C14E5'}; expno = 6; %expno = 23;%ExpNam = {'C14E5_3'}; expno = [8 27]; expno = 27;%ExpNam = {'C14E5_4'}; expno = 6;%ExpNam = {'C14E5_5'}; expno = 7;%ExpNam = {'AOToct8'};%ExpNam = {'AOToct9'}; S0max = 5.5e5; R2max = 40; R2min = 20;%ExpNam = {'C14E5_6'}; S0max = 2.5e5; R2max = 3; R2min = 1;ExpNam = {'C14E5_7'}; S0max = 3e5; R2max = 60; R2min = 15;%GetExpnamslb = 300e-6; si = 64; six = 16; siy = 32;lb = 150e-6; si = 128; six = 32; siy = six;%lb = 150e-6; si = 256; six = 64; siy = six;%lb = 75e-6; si = 512; six = 128; siy = six;td1start = 1;td1end = 32;thresh = .2;LoadSer = 0;MakeFit = 0;CheckThresh = 0;fs = 15;for ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    for nexp = 1:length(expno)        ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if all([strcmp('DT_t2imse3d',NMRacqus.pulprog); exist([num2str(expno(nexp)) '/ser'])])            if LoadSer                IMSE3Dtd1                Itd1 = abs(Itd1);                figure(3), clf                clim = [0 1];                for ntd1 = 1:tdim.td1                    axes('position',[(ntd1-1)/tdim.td1 0 1/tdim.td1 .7])                    Iplot = squeeze(Itd1(:,:,nudim.x/2+1,ntd1));                    imagesc(r.x*1e3,r.z*1e3,Iplot/Imax,clim)                    colormap('hot')                    axis equal, axis tight, axis off                    set(gca,'YDir','normal')                    axes('position',[(ntd1-1)/tdim.td1 .72 1/tdim.td1 .2])                    Iplot = squeeze(Itd1(nudim.z/2+1,:,:,ntd1));                    imagesc(r.x*1e3,r.y*1e3,Iplot/Imax,clim)                    colormap('hot')                    axis equal, axis tight, axis off                    set(gca,'YDir','normal')                    title(num2str(ntd1))                end                clear Iplot            end                                    if MakeFit                tau = NMRacqus.vd + 2*NMRacqus.d35;                Imask = zeros(nudim.z,nudim.y,nudim.x);                I1 = abs(squeeze(Itd1(:,:,:,td1start)));                Imask(find(I1>Imax*thresh)) = 1;                                figure(1), clf                colormap('gray')                ny = length(r.y)/2 + 1;                Iplot = squeeze(Imask(:,ny,:));                axh1 = axes('position',[.07 .1 .2 .9],'FontSize',fs);                imagesc(r.x*1e3,r.z*1e3,Iplot)                set(gca,'YDir','normal')                axis equal, axis tight                ylabel('\itz\rm / mm'), xlabel('\itx\rm / mm')                hold on                nx = length(r.x)/2 + 1;                axes('position',[.28 .1 .2 .9],'FontSize',fs)                Iplot = squeeze(Imask(:,:,nx));                imagesc(r.y*1e3,r.z*1e3,Iplot)                set(gca,'YDir','normal','YTick',[])                axis equal, axis tight                xlabel('\ity\rm / mm')                Nslices = 4^2;                slices = round(length(r.z)*linspace(0,1,Nslices+2)); slices([1 Nslices+2]) = [];                width = .5/sqrt(Nslices);                height = 11/8.5*.5/sqrt(Nslices);                nslice = 1;                for county = 1:sqrt(Nslices)                    for countx = 1:sqrt(Nslices)                        axes('position',[1-countx*width .2+(county-1)*height 1.01*width 1.01*height])                        nz = slices(nslice);                        Iplot = squeeze(Imask(nz,:,:));                        imagesc(r.x*1e3,r.y*1e3,Iplot)                        set(gca,'YDir','normal','YTick',[])                        axis tight, axis off                        nslice = nslice+1;                    end                end                pause(1)                                if CheckThresh                    return                end                                Images_S0 = zeros(si,siy,six);                Images_R2 = zeros(si,siy,six);                r_x = r.x; r_y = r.y; r_z = r.z;                nudim_x = nudim.x; nudim_y = nudim.y; nudim_z = nudim.z;                 options = optimset('MaxFunEvals',1e3,'Display','off');                tic%                 for nz = 1:nudim_z%                     nz%                     plot(axh1,1e3*[min(r_x); max(r_x)],r_z(nz)*1e3*[1; 1],'-b')%                     pause(.1)                parfor nz = 1:nudim_z                    nz                for ny = 1:nudim_y                for nx = 1:nudim_x                    points = td1start:min([tdim.td1 td1end]);                    Yin = abs(squeeze(Itd1(nz,ny,nx,points)));                    Xin = tau(points);                    Pin = [Yin(1)   100]; Funam = 'fexp';                    LB = [0 .01/max(tau)]; UB = [5*Yin(1) 3/min(tau)];                    if Yin(1)>Imax*thresh                        Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;                         [Pout,resnorm,residual,exitflag,output] = lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,options,Pnorm,Xnorm,Ynorm);                        Pout = Pout.*Pnorm;                        Ycalc = feval(Funam,Pout,Xin,ones(size(Pin)),1,1); error = Yin - Ycalc;                        %return                        %figure(2), clf, plot(points,Yin,'o',points,Ycalc,'-'), title(num2str(nz)); Pout', pause(.1)                        %return                        S0 = Pout(1);                        R2 = Pout(2);                        Images_S0(nz,ny,nx) = S0;                        Images_R2(nz,ny,nx) = R2;                    end                end                end                end                toc                Images.S0 = Images_S0;                Images.R2 = Images_R2;                eval(['save ' num2str(expno(nexp)) '/Images Images r'])            end            if exist([num2str(expno(nexp)) '/Images.mat'])                eval(['load ' num2str(expno(nexp)) '/Images'])                             if exist('S0max') == 0                    S0max = max(reshape(Images.S0,numel(Images.S0),1));                    S0max = .95*S0max;                end                if exist('R2max') == 0                    R2max = .9*max(reshape(Images.R2,numel(Images.R2),1));                    R2min = .1*R2max;                end                figure(2), clf                histdat = reshape(Images.S0,numel(Images.S0),1); histdat(histdat==0) = [];                subplot(1,2,1)                hist(histdat,50)                hold on                plot(S0max,0,'rx')                subplot(1,2,2)                histdat = reshape(Images.R2,numel(Images.R2),1); histdat(histdat==0) = [];                histdat = log10(histdat);                hist(histdat,50)                hold on                 plot(log10([R2min R2max]),[0 0],'rx')                xlabel('log(R2/s^-^1')                title(['R2min=' num2str(R2min,3) 's^-^1  R2max=' num2str(R2max,3) 's^-^1'])                c.bright = Images.S0/S0max;                C = (log10(Images.R2) - log10(R2min))/(log10(R2max) - log10(R2min));                C(C<0) = 0; C(C>1) = 1;                histdat = reshape(C,numel(C),1); histdat(histdat==0) = []; histdat(histdat==1) = [];                %figure(11), clf, hist(histdat,50), return                c.r = 2*C;                c.g = ones(size(C)) - 2*abs(.5-C);                c.b = 1-2*C;                c.bright(isnan(c.bright)) = 0; c.bright(isinf(c.bright)) = 0;                c.r(isnan(c.r)) = 0; c.r(isinf(c.r)) = 0;                c.g(isnan(c.g)) = 0; c.g(isinf(c.g)) = 0;                c.b(isnan(c.b)) = 0; c.b(isinf(c.b)) = 0;                c.bright(c.bright<0) = 0; c.bright(c.bright>1) = 1;                c.r(c.r<0) = 0; c.r(c.r>1) = 1;                c.b(c.b<0) = 0; c.b(c.b>1) = 1;                c.g(c.g<0) = 0; c.g(c.g>1) = 1;                figure(1), clf                           histdat = reshape(Images.S0,numel(Images.S0),1); histdat(histdat==0) = [];                axes('position',[.55 .85 .15 .1],'FontSize',fs)                hist(histdat,50)                hold on                plot(S0max,0,'rx')                axis tight                title(['S0max=' num2str(S0max,3)])                axes('position',[.8 .85 .15 .1],'FontSize',fs)                histdat = reshape(Images.R2,numel(Images.R2),1); histdat(histdat==0) = [];                histdat = log10(histdat);                hist(histdat,50)                hold on                 plot(log10([R2min R2max]),[0 0],'rx')                axis tight                xlabel('log(R2/s^-^1')                title(['R2min=' num2str(R2min,3) 's^-^1  R2max=' num2str(R2max,3) 's^-^1'])                ny = length(r.y)/2 + 1;                axes('position',[.07 .1 .2 .9],'FontSize',fs)                C = zeros(length(r.z),length(r.x),3);                C(:,:,1) = squeeze(c.r(:,ny,:).*c.bright(:,ny,:));                C(:,:,2) = squeeze(c.g(:,ny,:).*c.bright(:,ny,:));                C(:,:,3) = squeeze(c.b(:,ny,:).*c.bright(:,ny,:));                image(r.x*1e3,r.z*1e3,C)                set(gca,'YDir','normal')                axis equal, axis tight                ylabel('\itz\rm / mm'), xlabel('\itx\rm / mm')                nx = length(r.x)/2 + 1;                axes('position',[.28 .1 .2 .9],'FontSize',fs)                C = zeros(length(r.z),length(r.y),3);                C(:,:,1) = squeeze(c.r(:,:,nx).*c.bright(:,:,nx));                C(:,:,2) = squeeze(c.g(:,:,nx).*c.bright(:,:,nx));                C(:,:,3) = squeeze(c.b(:,:,nx).*c.bright(:,:,nx));                image(r.y*1e3,r.z*1e3,C)                set(gca,'YDir','normal','YTick',[])                axis equal, axis tight                xlabel('\ity\rm / mm')                Nslices = 5^2;                slices = round(length(r.z)*linspace(0,1,Nslices+2)); slices([1 Nslices+2]) = [];                width = .5/sqrt(Nslices);                height = 11/8.5*.5/sqrt(Nslices);                nslice = 1;                for county = 1:sqrt(Nslices)                    for countx = 1:sqrt(Nslices)                        axes('position',[1-countx*width .1+(county-1)*height 1.01*width 1.01*height])                        nz = slices(nslice);                        C = zeros(length(r.y),length(r.x),3);                        C(:,:,1) = squeeze(c.r(nz,:,:).*c.bright(nz,:,:));                        C(:,:,2) = squeeze(c.g(nz,:,:).*c.bright(nz,:,:));                        C(:,:,3) = squeeze(c.b(nz,:,:).*c.bright(nz,:,:));                        image(r.x*1e3,r.y*1e3,C)                        set(gca,'YDir','normal','YTick',[])                        axis tight, axis off                        nslice = nslice+1;                    end                end                delete([num2str(expno(nexp)) '/ReportFig.*'])                delete([num2str(expno(nexp)) '/acqu*sconv'])                delete([num2str(expno(nexp)) '/*Dat.mat'])                delete([num2str(expno(nexp)) '/*.jpg'])                set(gcf, 'PaperPosition', [0 0 11 8.5],'PaperSize', [11 8.5]);                 eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -dpdf'])            end        end    end    cd ..endcd(wd)