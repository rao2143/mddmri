clear allwd = cd;%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/Users/daniel/NMRdata/AVII500/DT';%ExpNam = {'DTItest'}; expno = 118;%ExpNam = {'NafionDTI'}; expno = 17;%ExpNam = {'DTI_HHnerve'}; %expno = 413;%ExpNam = {'ToothPickPhantom'};%ExpNam = {'MIC5_10mm_setup'};%ExpNam = {'HHnerve3'};%ExpNam = {'HHnerve4'};%ExpNam = {'isoaniso_test'};%ExpNam = {'uFA_RARE'}; expno = 75;%ExpNam = {'DiffVACSY'}; expno = 93;%ExpNam = {'MIC5_2H_setup'}; expno = 22;%ExpNam = {'AOToct8'};%ExpNam = {'AOToct9'};ExpNam = {'C14E5_6'};lb = 150e-6;si = 32; si1 = si;td1start = 2;td1end = 32;thresh = .2;MakeFit = 1;fs = 15;cd(DataDir)%GetExpnamsfor ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    for nexp = 1:length(expno)        ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if any(strcmp(NMRacqus.pulprog,{'DT_t1rare2d'})) == 1                        RARE2Dtd1                        Imax = abs(Itd1);            Imax(nudim.i/2+(0:2),nudim.j/2+(0:2),:) = 0;            Imax = max(reshape(Imax,numel(Imax),1));            tau = NMRacqus.vd + 2*NMRacqus.d32 + 0.5*NMRacqus.p12*1e-6;            Images.S0 = zeros(nudim.i,nudim.j);            Images.R1 = zeros(nudim.i,nudim.j);            Images.A = zeros(nudim.i,nudim.j);            if MakeFit                for nj = 1:nudim.j                               for ni = 1:nudim.i                        index.fit = td1start:min([td1 td1end]);                        Yin = abs(squeeze(Itd1(ni,nj,index.fit)));                        Xin = tau(index.fit);                        Pin = [max(Yin) .5 1.5]; Funam = 'fIRabs';                        LB = [.5*max(Yin) .1 .1]; UB = [2*max(Yin) 1/min(Xin) 5];                        if max(Yin)>Imax*thresh                            Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = abs(Pin);                             [Pout,resnorm,residual,exitflag,output] = lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,[],Pnorm,Xnorm,Ynorm); Pout = Pout.*Pnorm;                            Ycalc = feval(Funam,Pout,Xin,ones(size(Pin)),1,1); error = Yin - Ycalc;                            %figure(2), clf, plot(index.fit,Yin,'o',index.fit,Ycalc,'-'), title(num2str(nj)); pause(.1)                            %return                                                        Images.S0(ni,nj) = Pout(1);                            Images.R1(ni,nj) = Pout(2);                            Images.A(ni,nj) = Pout(3);                         end                                      end                end                eval(['save ' num2str(expno(nexp)) '/Images Images r'])            else                eval(['load ' num2str(expno(nexp)) '/Images'])            end            %%            rmax.i = max(r.i)*1e3;            rmax.j = max(r.j)*1e3;                        %R1max = max(max(Images.R1));            R1max = 1.5*sum(sum((Images.S0.*Images.R1),1),2)/sum(sum((Images.S0),1),2);            %R1max = 5;            figure(3), clf            colormap('hot')            axes('position',[.1 .6 .4 .35])            Iplot = squeeze(Images.S0(:,:)/Imax);            clim = [0 1];            imagesc(r.i*1e3,r.j*1e3,Iplot',clim)            set(gca,'YDir','normal')            axis equal, axis tight            xlabel('read / mm'), ylabel('phase / mm')            title('S0')            colorbar            axes('position',[.6 .6 .4 .35])            Iplot = squeeze(Images.R1(:,:));            clim = [0 R1max];            imagesc(r.i*1e3,r.j*1e3,Iplot',clim)            set(gca,'YDir','normal')            axis equal, axis tight            xlabel('read / mm'), ylabel('phase / mm')            title(['R1 / s^-^1'])            colorbar            axes('position',[.6 .1 .4 .35])            Iplot = squeeze(Images.A(:,:));            clim = [0 2];            imagesc(r.i*1e3,r.j*1e3,Iplot',clim)            set(gca,'YDir','normal')            axis equal, axis tight            xlabel('read / mm'), ylabel('phase / mm')            title('A')            colorbar%%            delete([num2str(expno(nexp)) '/ReportFig*'])            delete([num2str(expno(nexp)) '/acqu*sconv'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            set(gcf, 'PaperPosition', [0 0 11 8.5],'PaperSize', [11 8.5]);             eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -dpdf'])        end    end    cd ..endcd(wd)