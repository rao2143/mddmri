clear allwd = cd;%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/Users/daniel/NMRdata/AVII500/DT';%ExpNam = {'DTItest'}; expno = 339;%ExpNam = {'NafionDTI'}; expno = 35;%ExpNam = {'DTI_HHnerve'}; expno = 413;ExpNam = {'MIC5_10mm_gradcalib'}; %expno = 301; expno = 301:320;ExpNam = {'MIC5_10mm_setup'}; %expno = 77;ExpNam = {'HHnerve3'}; %expno = 77;ExpNam = {'RARE_PGSTE'};ExpNam = {'HHnerve4'};lb = 2e-4;%si = 128;fs = 15;cd(DataDir)%GetExpnamsfor ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    for nexp = 1:length(expno)        ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if any(strcmp(NMRacqus.pulprog,{'DT_dtirare2d','DT_pgstedtirare2d','DT_dpgsedtirare2d'})) == 1            RARE2Dtd1            fid = fopen([num2str(expno(nexp)) '/difframp_x.txt']);            difframp.x = fscanf(fid,'%f');            fclose(fid);            fid = fopen([num2str(expno(nexp)) '/difframp_y.txt']);            difframp.y = fscanf(fid,'%f');            fclose(fid);            fid = fopen([num2str(expno(nexp)) '/difframp_z.txt']);            difframp.z = fscanf(fid,'%f');            fclose(fid);            G.x = difframp.x*Gmax.*NMRacqus.cnst1/100;            G.y = difframp.y*Gmax.*NMRacqus.cnst2/100;            G.z = difframp.z*Gmax.*NMRacqus.cnst3/100;            G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);            Gnorm.x = G.x./G.r;            Gnorm.y = G.y./G.r;            Gnorm.z = G.z./G.r;            if any(strcmp(NMRacqus.pulprog,{'DT_dtirare2d'})) == 1                delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;                Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p12/1e6+4*NMRacqus.d32;                tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;                q = gamma*G.r*delta/2/pi;                b = (2*pi*q).^2*tdiff;            elseif any(strcmp(NMRacqus.pulprog,{'DT_pgstedtirare2d'})) == 1                delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;                Delta = delta+epsilon+2*NMRacqus.d4+2*NMRacqus.p1/1e6+NMRacqus.d5;                if NMRacqus.l11                    Delta = Delta+2*NMRacqus.d42+NMRacqus.d43;                end                tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;                q = gamma*G.r*delta/2/pi;                b = 2*(2*pi*q).^2*tdiff;            elseif any(strcmp(NMRacqus.pulprog,{'DT_dpgsedtirare2d'})) == 1                delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;                Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p12/1e6+4*NMRacqus.d32;                tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;                q = gamma*G.r*delta/2/pi;                b = 2*(2*pi*q).^2*tdiff;            end                        Imax = abs(Itd1);            Imax(nudim.i/2+(0:2),nudim.j/2+(0:2),2:td1) = 0;            Imax(:,:,1) = 0;            Imax = max(reshape(Imax,numel(Imax),1));            rmax.i = max(r.i)*1e3;            rmax.j = max(r.j)*1e3;            figure(2), clf            colormap(hot(256));            clim = [0 1];                        td1dim.x = ceil(11/8*sqrt(td1));            td1dim.y = ceil(8/11*sqrt(td1));            if any(strcmp(NMRacqus.pulprog,{'DT_dtirare2d','DT_pgstedtirare2d','DT_dpgsedtirare2d'})) == 1                                        td1dim.x = 8;                td1dim.y = ceil(td1/td1dim.x);            end            width = .5/td1dim.x;            height = 1/td1dim.y;            ntd1 = 1;            for ycount = 1:td1dim.y;                for xcount = 1:td1dim.x;                    if ntd1 <= td1;                        axes('position',[(xcount-1)*width 1-ycount*height width height])                        Iplot = squeeze(abs(Itd1(:,:,ntd1)))/Imax;                        imagesc(r.i*1e3,r.j*1e3,Iplot',clim)                        set(gca,'YDir','normal')                        axis equal, axis tight, axis off                    end                    ntd1 = ntd1+1;                end            end                        %%            Itot = squeeze(sum(sum(abs(Itd1(:,:,:)),1),2));            axes('position',[.6 .63 .35 .3],'FontSize',fs)            plot(1:td1,Itot,'o'), xlabel('td1')            axis tight            set(gca,'FontSize',fs,'YLim',max(Itot(2:numel(Itot)))*[-.1 1.1])            axes('position',[.6 .12 .35 .3],'FontSize',fs)            semilogx(q(1:td1),Itot,'o'), xlabel('q / m')            title(['\delta=' num2str(delta/1e-3,2) 'ms t_d=' num2str(tdiff/1e-3,2) 'ms'])            axis tight            set(gca,'FontSize',fs,'YLim',max(Itot(2:numel(Itot)))*[-.1 1.1],'XTick',[1e4 1e5 1e6])                        Idat.I = Itot;            Idat.q = q;            Idat.b = b;            Idat.Gnorm = Gnorm;            Idat.delta = delta;            Idat.epsilon = epsilon;            Idat.Delta = Delta;            Idat.tdiff = tdiff;            eval(['save ' num2str(expno(nexp)) '/Idat Idat'])                        dat = [q(1:length(Itot)) Itot];            eval(['save ' num2str(expno(nexp)) '/Idat.txt dat -ascii -tabs'])                        %%                        delete([num2str(expno(nexp)) '/ReportFig*'])            delete([num2str(expno(nexp)) '/acqu*sconv'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -depsc'])                    end    end    cd ..endcd(wd)