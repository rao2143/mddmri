clear allwd = cd;%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/Users/daniel/NMRdata/AVII500/DT';%ExpNam = 'uFA_RARE'; %expno = 19;%expno = 102; Pixel.x = [67; 67; 70; 93]; Pixel.y = [20; 37; 76; 86];%expno = 112; Pixel.x = [67; 67; 74; 67]; Pixel.y = [20; 40; 54; 99];%expno = 109; Pixel.x = [67; 67; 70; 93]; Pixel.y = [20; 37; 76; 86];%expno = 89;%ExpNam = 'SjolundOpt'; expno = 7:14; expno = 14;%Pixel.x = 2*[36 36 36 45]; Pixel.y = 2*[16 35 45 50]; ExpNam = 'C14E5_5'; expno = 5;Pixel.x = [36 36 36 45]; Pixel.y = [16 35 45 50]; cd([DataDir '/' ExpNam])eval(['load ' num2str(expno) '/NMRacqus'])eval(['load ' num2str(expno) '/Images'])Images.Dxyz.r = Images.lambda1;Images.Dxyz.x = Images.Dxx./Images.Dxyz.r;Images.Dxyz.y = Images.Dyy./Images.Dxyz.r;Images.Dxyz.z = Images.Dzz./Images.Dxyz.r;ADCmax = max(reshape(Images.ADC,numel(Images.ADC),1));Dmax = max([max(reshape(Images.Dxx,numel(Images.ADC),1)) max(reshape(Images.Dyy,numel(Images.ADC),1)) max(reshape(Images.Dzz,numel(Images.ADC),1))]);Images.DeltaK = (Images.mu2_aniso-Images.mu2_iso)./Images.mD_gamma.^2;Images.K_aniso = Images.mu2_aniso./Images.mD_gamma.^2;Images.DeltaK_FA = 1./(5/2*(1./(Images.FA/sqrt(3/2)).^2 - 1));Images.OD = (Images.uFA - Images.FA)./Images.uFA;%Images.OP = sqrt(Images.DeltaK_FA./Images.DeltaK);Images.OP = sqrt(Images.DeltaK_FA./Images.DeltaK);%Images.OD = (Images.uFA - Images.FA);% figure(1), clf, imagesc(Images.mu2_iso')% set(gca,'YDir','normal'), axis square% hold on% plot(47,91,'kx')% return%uFA = sqrt(3/2)*sqrt(1/(1+2/5*mD_gamma^2/(mu2_aniso-mu2_iso)));%figure(1), clf, plot(Images.K_aniso,Images.K,'.'), return%figure(1), clf, plot(Images.FA,Images.DeltaK,'.'), returnCmax = 1;ADCmax = 2e-9;%Dmax = 2e-9;maskbin = [Images.S0 > .15*max(max(Images.S0)) & Images.FA>0.2];maskbin = [Images.S0 > .15*max(max(Images.S0)) & Images.uFA>0.4];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.uFA>0.7...%     & Images.FA>0.5 & Images.K<.03];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.uFA>0.65...%     & Images.FA<0.1 & Images.K<.02];maskbin = [Images.S0 > .05*max(max(Images.S0))];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.K>.15 ...%     & Images.K_aniso>.45 & Images.DeltaK>.2];%maskbin = [Images.S0 > .14*max(max(Images.S0)) & Images.DeltaK>0.15];%maskbin = [Images.S0 > .05*max(max(Images.S0)) & Images.mD_gamma < 1e-9];%maskbin = ones(size(Images.S0));mask = find(maskbin);[mask_x,mask_y] = find(maskbin);invmask = find(maskbin==0);%%width = .2;height = width*11/8.5;dleft = width+.05;dbottom = .1;hwidth = .6*widthhheight = height-.1;fs = 4*11/3.33; lw = .5*11/3.33; tl = .04;figure(3), clfcolormap('gray')left = .08;bottom = .7;axes('position',[left bottom width height])Iplot = squeeze(Images.mD_gamma(:,:));%Iplot = squeeze(Images.ADC(:,:));Iplot(invmask) = 0;clim = [0 ADCmax];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = 1/1e-9*reshape(Images.mD_gamma,numel(Images.FA),1);%histdat = 1/1e-9*reshape(Images.ADC,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 2*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])bottom = .4;axes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.FA(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = (Iplot.*Images.Dxyz.x)';Iplot2(:,:,2) = (Iplot.*Images.Dxyz.y)';Iplot2(:,:,3) = (Iplot.*Images.Dxyz.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;%imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offset(gca,'FontSize',fs,'Box','off','TickDir','out','TickLength',.02*[1 1],'LineWidth',lw)hold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.FA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];%xlim = clim;set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])bottom = .1;axes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.CP(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = abs(Iplot.*Images.v3.x)';Iplot2(:,:,2) = abs(Iplot.*Images.v3.y)';Iplot2(:,:,3) = abs(Iplot.*Images.v3.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)set(gca,'YDir','normal')axis equal, axis tightset(gca,'FontSize',fs,'Box','off','TickDir','out','TickLength',.02*[1 1],'LineWidth',lw)hold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.CP,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];%xlim = clim;set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])left = .6;bottom = .7;axes('position',[left bottom width height])Iplot = squeeze(Images.K_aniso(:,:));Iplot(invmask) = 0;clim = [0 Cmax];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.K_aniso,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])bottom = .4;axes('position',[left bottom width height])Iplot = squeeze(Images.K(:,:));Iplot(invmask) = 0;clim = [0 Cmax];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.K,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])bottom = .1;axes('position',[left bottom width height])Iplot = squeeze(Images.DeltaK(:,:));Iplot(invmask) = 0;clim = [0 Cmax];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endend% clim = .4;% Iplot = zeros([size(Images.FA) 3]);% Iplot(:,:,1) = (Images.DeltaK/clim.*Images.Dxyz.x)';% Iplot(:,:,2) = (Images.DeltaK/clim.*Images.Dxyz.y)';% Iplot(:,:,3) = (Images.DeltaK/clim.*Images.Dxyz.z)';% Iplot(find(Iplot>1)) = 1;% Iplot(find(Iplot<0)) = 0;% imagesc(r.i*1e3,r.j*1e3,Iplot)% title('DeltaK Dxx,Dyy,Dzz')set(gca,'YDir','normal')axis equal, axis tight, axis offhistdat = reshape(Images.DeltaK,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])eval(['print ' num2str(expno) '/Images_Histograms -loose -depsc'])%%maskbin = [Images.S0 > .05*max(max(Images.S0)) & Images.DeltaK>0.05 & ...    Images.mD_gamma<2e-9];mask = find(maskbin);invmask = find(maskbin==0);figure(4), clfcolormap('gray')left = .08;bottom = .7;axes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.FA(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = (Iplot.*Images.Dxyz.x)';Iplot2(:,:,2) = (Iplot.*Images.Dxyz.y)';Iplot2(:,:,3) = (Iplot.*Images.Dxyz.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)%imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhistdat = reshape(Images.FA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];%xlim = clim;set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])bottom = .25;axes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.uFA(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = (Iplot.*Images.Dxyz.x)';Iplot2(:,:,2) = (Iplot.*Images.Dxyz.y)';Iplot2(:,:,3) = (Iplot.*Images.Dxyz.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)%imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tightset(gca,'FontSize',fs,'Box','off','TickDir','out','TickLength',.02*[1 1],'LineWidth',lw)histdat = reshape(Images.uFA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];%xlim = clim;set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])left = .65;bottom = .7;histdat1 = reshape(Images.FA,numel(Images.FA),1);histdat1 = histdat1(mask);histdat2 = reshape(Images.uFA,numel(Images.FA),1);histdat2 = histdat2(mask);axes('position',[left bottom width height])plot(histdat1,histdat2,'b.','MarkerSize',2)hold onplot([0 1],[0 1],'k-','LineWidth',lw)plot([0 1],1/sqrt(2)*[1 1],'k--','LineWidth',lw)%plot(1/sqrt(2)*[1 1],[0 1],'k--','LineWidth',lw)set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',xlim)% bottom = .2;% left = .08;% axes('position',[left bottom width height])% yslice = 62;% plot(r.i*1e3,Images.FA(:,yslice),'b-')% hold on% plot(r.i*1e3,Images.uFA(:,yslice),'r-')% %plot(r.i*1e3,Images.OD(:,yslice),'k-')% set(gca,'YLim',[-.1 1.1])left = .6;bottom = .25;axh_OD = axes('position',[left bottom width height]);clim = [0 1];Iplot = squeeze(Images.OP(:,:))/max(clim);Iplot(invmask) = 0;imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offcmap = colormap(jet(128));cmap(1,:) = 0;colormap(axh_OD,cmap)axh_cbar = axes('position',[left+dleft bottom+dbottom+hheight-.02 ...    hwidth .02]);imagesc([0 1], linspace(0,1,128)',[linspace(0,1,128); linspace(0,1,128)])set(gca,'XLim',[-.2 1.2])axis offhistdat = reshape(Images.OP,numel(Images.FA),1);histdat = histdat(mask);axes('position',[left+dleft bottom+dbottom hwidth hheight-.02])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];%xlim = clim;set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[0])eval(['print ' num2str(expno) '/FA_uFA_OP -loose -depsc'])cd(wd)