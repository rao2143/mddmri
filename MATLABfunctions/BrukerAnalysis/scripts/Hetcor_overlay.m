clear allMkReportFig=1;fignam = 'hetcor_multi';data_path = '/Users/daniel/Dropbox/NMRdata/Faellanden';expnam = 'ZHAA03_dTopgaard_210322_SC_MariaG_20221117';expno = [200:207 300:306]; %expno = 205; %13C% expnam = 'ZHAA03_dTopgaard_210322_SC_MariaG_20221205';% expno = [300:307];Imin = .02; Imax = 1; ppmmin = -5; ppmmax = 190; ppmmin1 = -3; ppmmax1 = 12;% ppmmin = 5; ppmmax = 20; ppmmin1 = 0; ppmmax1 = 2;% peakppmmin1 = 7.0; peakppmmax1 = 8.5;% peaks  = [24.6 32.7 42.4 55.7 128.7 171.8 175.2]; % peaks1 = [ 1.3  1.3  3.5  4.1   7.0   8.1   8.0];% peaks  = [14.2 32.7 42.4 55.7 128.7 175.2];% peaks1 = [ 1.0 1.3  3.5  4.1   7.0   7.5];peaks  = [32.7 55.7 175.2];peaks1 = [ 1.3  4.1   7.5];peakppmmin = peaks - .4; peakppmmax = peaks + .4;peakppmmin1 = peaks1 - .4; peakppmmax1 = peaks1 + .4;% data_path = '/Users/daniel/Dropbox/NMRdata/AV4_500/daniel/';% expnam = '20220922_CTADNAwet_edumbosdhetcor';% Imin = .02; Imax = .2; expno = -100+[201:208 210:215 217:225 227:231 233 236:242 244:247]; %13C% ppmmin = -5; ppmmax = 185; ppmmin1 = -1; ppmmax1 = 11;% expno = [201:208 210:215 217:225 227:231 233 236:242 244:247]; fignam = 'hetcor_multi_31P.tex'; %31P% Imin = .02; Imax = .8; % ppmmin = -20; ppmmax = 20;% data_path = '/Users/daniel/Dropbox/NMRdata/AV4_500/daniel/';% expnam = '20220223_POPCGM3AS';% expno = [223 226 237 238 233 234 224 227 229 230 241]; %expno = 223; %13C% Imin = .03; Imax = 1; % % ppmmin = -5; ppmmax = 185; ppmmin1 = -1; ppmmax1 = 11;% % expno = [220 239 235 221 231]; fignam = 'hetcor_multi_31P.tex'; %31P% % Imin = .1; Imax = 1; % % ppmmin = -9; ppmmax = 9;% peakppmmin1 = 4.5; peakppmmax1 = 4.8;% data_path = '/Users/daniel/Dropbox/NMRdata/SNC/DNP';% expnam = '210510_SC_Topgaard';% Imin = .005; Imax = .25; expno = [10:18 20:23 25:48]; fignam = 'hetcor_multi.tex';% ppmmin = -30; ppmmax = 230; ppmmin1 = -3; ppmmax1 = 13;% Imin = .15; Imax = 1; expno = [29:39]; fignam = 'hetcor_multi_sd.tex';% ppmmin = 5; ppmmax = 85; ppmmin1 = -3; ppmmax1 = 11;% Imin = .05; Imax = .35; expno = [40:48]; fignam = 'hetcor_multi_sd_long.tex';% ppmmin = 5; ppmmax = 85; ppmmin1 = -3; ppmmax1 = 11;% Imin = .05; Imax = .35; expno = [40:48]; fignam = 'hetcor_multi_sd_long_wide.tex';% ppmmin = 5; ppmmax = 195; ppmmin1 = -3; ppmmax1 = 11;% Imin = .005; Imax = .25; expno = [10:50]; fignam = 'hetcor_multi_expno.tex';% ppmmin = -30; ppmmax = 230; ppmmin1 = -3; ppmmax1 = 13;% expnam = '210429_SC_Topgaard';% % Imin = .1; Imax = 1; expno = [8 6 5 7 9]; fignam = 'hetcor_5to9.tex';% Imin = .04; Imax = 1; expno = [11:17]; fignam = 'hetcor_11to17.tex';% ppmmin = -30; ppmmax = 230; ppmmin1 = -3; ppmmax1 = 13;% data_path = '/Users/daniel/Dropbox/NMRdata/AV4_500/Simon/';% expnam = 'POPC_GM3_AS_hetcor';% Imin = .05; Imax = .5; expno = [58:64]; fignam = 'hetcor_58to64.tex';% Imin = .1; Imax = 1; expno = [67:73]; fignam = 'hetcor_67to73.tex';% ppmmin = -30; ppmmax = 230; ppmmin1 = -3; ppmmax1 = 13;% data_path = '/Users/daniel/Dropbox/NMRdata/SNC/DNP';% expnam = '210422_SC_Topgaard';% Imin = .005; Imax = .12; expno = [49 41 50 51 57];% ppmmin = -30; ppmmax = 230; ppmmin1 = -3; ppmmax1 = 13;nexp = 1;spec_fn = fullfile(data_path,expnam,num2str(expno(nexp)),'SpecDat.mat');load(spec_fn)I = Spec.I;ppm = Spec.ppm;ppm1 = Spec.ppm1;Iarray = zeros(size(I,1),size(I,2),numel(expno));for nexp = 1:length(expno)        spec_fn = fullfile(data_path,expnam,num2str(expno(nexp)),'SpecDat.mat');    load(spec_fn)    Iarray(:,:,nexp) = Spec.I;    NMRacqus_fn = fullfile(data_path,expnam,num2str(expno(nexp)),'NMRacqus.mat');    load(NMRacqus_fn)    d1_v(nexp) = NMRacqus.d1;    p15_v(nexp) = NMRacqus.p15;    d8_v(nexp) = NMRacqus.d8;    if any(strcmp(NMRacqus.pulprog,{'DT_hetcorin','DT_hetcorcp','DT_edumbohetcorcp','DT_edumbohetcorcpdr','lghetfq'}) == 1)        d8_v(nexp) = NaN;    end    if any(strcmp(NMRacqus.pulprog,{'DT_hetcorin','DT_sdhetcorin'}) == 1)        p15_v(nexp) = NaN;    endendif exist('ppmmin') == 0    ppmmin = min(ppm);    ppmmax = max(ppm);endif exist('ppmmin1') == 0    ppmmin1 = min(ppm1);    ppmmax1 = max(ppm1);end    maxI = max(Iarray(:));minI = Imin*maxI;Npeaks = numel(peaks);Npeaks1 = numel(peaks1);peak_I = zeros(Npeaks,Npeaks1,size(Iarray,3));peak_ppm = zeros(size(peak_I));peak_ppm1 = zeros(size(peak_I));[ppm_a,ppm1_a,nexp_a] = ndgrid(ppm,ppm1,1:length(expno));for npeak = 1:Npeaks    for npeak1 = 1:Npeaks1        mask = zeros(size(Iarray));        mask(ppm>peakppmmin(npeak)&ppm<peakppmmax(npeak),ppm1>peakppmmin1(npeak1)&ppm1<peakppmmax1(npeak1),:) = 1;        [maxval,maxind] = max(mask.*Iarray,[],[1 2],'linear');        peak_I(npeak,npeak1,:) = maxval;        peak_ppm(npeak,npeak1,:) = ppm_a(maxind);        peak_ppm1(npeak,npeak1,:) = ppm1_a(maxind);            endend%%peak_Iproj = zeros(Npeaks,size(Iarray,2),size(Iarray,3));for npeak = 1:Npeaks    peak_Iproj(npeak,:,:) = squeeze(max(Iarray(find(ppm>peakppmmin(npeak)&ppm<peakppmmax(npeak)),:,:)/maxI,[],1));endpeak1_Iproj = zeros(size(Iarray,1),Npeaks1,size(Iarray,3));for npeak1 = 1:Npeaks1    peak1_Iproj(:,npeak1,:) = squeeze(max(Iarray(:,find(ppm1>peakppmmin1(npeak1)&ppm1<peakppmmax1(npeak1)),:)/maxI,[],2));endaspect = 1.6;papersize = 2*8.3*[1 1/aspect];fs = 12;lw = 1;lw_cont = .3;lw_v = [1.5*lw lw .67*lw .5*lw .33*lw .33*lw .33*lw];col_a = [1 0 0    0 .8 0    0 0 1    .8 .8 0    .8 0 .8    0 .8 .8    .85 .85 .85];%%nacq_v = (1:length(expno))';Nsubplots = 4;figure(1), clfnsubplot = 1; subplot(Nsubplots,1,nsubplot)plot(nacq_v,log10(p15_v/1e6)','ko',nacq_v,log10(d8_v)','kx'), set(gca,'XLim',[0 max(nacq_v)+1])nsubplot = nsubplot + 1; subplot(Nsubplots,1,nsubplot)plot(nacq_v,squeeze(peak_I(1,2,:)./(peak_I(1,1,:)+peak_I(2,2,:)))','-o','Color',col_a(2,:)), set(gca,'XLim',[0 max(nacq_v)+1])hold onplot(nacq_v,squeeze(peak_I(1,3,:)./(peak_I(1,1,:)+peak_I(3,3,:)))','-o','Color',col_a(3,:)), set(gca,'XLim',[0 max(nacq_v)+1])nsubplot = nsubplot + 1; subplot(Nsubplots,1,nsubplot)plot(nacq_v,squeeze(peak_I(2,1,:)./(peak_I(2,2,:)+peak_I(1,1,:)))','-o','Color',col_a(1,:)), set(gca,'XLim',[0 max(nacq_v)+1])hold onplot(nacq_v,squeeze(peak_I(2,3,:)./(peak_I(2,2,:)+peak_I(3,3,:)))','-o','Color',col_a(3,:)), set(gca,'XLim',[0 max(nacq_v)+1])nsubplot = nsubplot + 1; subplot(Nsubplots,1,nsubplot)plot(nacq_v,squeeze(peak_I(3,1,:)./(peak_I(3,3,:)+peak_I(1,1,:)))','-o','Color',col_a(1,:)), set(gca,'XLim',[0 max(nacq_v)+1])hold onplot(nacq_v,squeeze(peak_I(3,2,:)./(peak_I(3,3,:)+peak_I(2,2,:)))','-o','Color',col_a(2,:)), set(gca,'XLim',[0 max(nacq_v)+1])fig_fn = fullfile(data_path,expnam,[fignam '_intensity_array.pdf']);print(fig_fn, '-dpdf', '-loose')%%Nsubplots = 3;p15_v(isnan(p15_v)) = 0;d8_v(isnan(d8_v)) = 0;tmeff = sqrt((.5*p15_v/1e6 + d8_v)');figure(1), clfnsubplot = 1; subplot(Nsubplots,1,nsubplot)plot(tmeff,squeeze(peak_I(1,2,:)./(peak_I(1,1,:)+peak_I(2,2,:)))','-o','Color',col_a(2,:))hold onplot(tmeff,squeeze(peak_I(1,3,:)./(peak_I(1,1,:)+peak_I(3,3,:)))','-o','Color',col_a(3,:))nsubplot = nsubplot + 1; subplot(Nsubplots,1,nsubplot)plot(tmeff,squeeze(peak_I(2,1,:)./(peak_I(2,2,:)+peak_I(1,1,:)))','-o','Color',col_a(1,:))hold onplot(tmeff,squeeze(peak_I(2,3,:)./(peak_I(2,2,:)+peak_I(3,3,:)))','-o','Color',col_a(3,:))nsubplot = nsubplot + 1; subplot(Nsubplots,1,nsubplot)plot(tmeff,squeeze(peak_I(3,1,:)./(peak_I(3,3,:)+peak_I(1,1,:)))','-o','Color',col_a(1,:))hold onplot(tmeff,squeeze(peak_I(3,2,:)./(peak_I(3,3,:)+peak_I(2,2,:)))','-o','Color',col_a(2,:))fig_fn = fullfile(data_path,expnam,[fignam '_intensity_tmeff_array.pdf']);print(fig_fn, '-dpdf', '-loose')%%% figure(1), clf% subplot(3,3,1)% plot((1:length(expno))',squeeze(peak_I(1,:,:))'/maxI,'o')% subplot(3,3,4)% plot((1:length(expno))',squeeze(peak_I(2,:,:))'/maxI,'o')% subplot(3,3,7)% plot((1:length(expno))',squeeze(peak_I(3,:,:))'/maxI,'o')% subplot(3,3,2)% plot((1:length(expno))',squeeze(peak_I(1,:,:)./repmat(sum(peak_I(1,:,:),2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% subplot(3,3,5)% plot((1:length(expno))',squeeze(peak_I(2,:,:)./repmat(sum(peak_I(2,:,:),2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% subplot(3,3,8)% plot((1:length(expno))',squeeze(peak_I(3,:,:)./repmat(sum(peak_I(3,:,:),2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% subplot(3,3,3)% plot((1:length(expno))',squeeze(peak_I(1,:,:)./repmat(max(peak_I(1,:,:),[],2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% subplot(3,3,6)% plot((1:length(expno))',squeeze(peak_I(2,:,:)./repmat(max(peak_I(2,:,:),[],2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% subplot(3,3,9)% plot((1:length(expno))',squeeze(peak_I(3,:,:)./repmat(max(peak_I(3,:,:),[],2),[1 Npeaks1 1]))','o')% set(gca,'YLim',[-.05 1.05])% % returnbottom_cm = 1.5;dheight_cm = 1;papersize_cm = 2*[8.3 bottom_cm+dheight_cm*nexp];if nexp == 1    papersize_cm = 2*[8.3 bottom_cm+dheight_cm*3];endbottom = bottom_cm/papersize_cm(2);figure(2), clf    axes('position',[0 bottom 1 1-bottom],'LineWidth',lw,'FontSize',fs)for npeak1 = 1:Npeaks1    for nexp = 1:length(expno)        Itemp = squeeze(peak1_Iproj(:,npeak1,nexp));%         Itemp = Itemp/maxI;        Itemp = Itemp/max(Itemp(:));        plot(ppm,1*Itemp + (nexp-1),'Color',col_a(npeak1,:),'LineWidth',lw_v(npeak1))        hold on    endendhold offset(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,...    'Box','off','TickDir','out','Ycolor','none')axis([ppmmin ppmmax -.2 length(expno)+ .01])xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'])figtrace_fn = fullfile(data_path,expnam,[fignam '_slices.pdf']);set(gcf, 'PaperUnits','centimeters','PaperPosition', [0 0 papersize_cm],'PaperSize', papersize_cm);set(gcf,'Render','painters')% set(gcf,'color','none','inverthardcopy','off');print(figtrace_fn, '-dpdf', '-loose')figure(3), clf    axes('position',[0 bottom 1 1-bottom],'LineWidth',lw,'FontSize',fs)for npeak = 1:Npeaks    for nexp = 1:length(expno)        Itemp = squeeze(peak_Iproj(npeak,:,nexp));%         Itemp = Itemp/maxI;        Itemp = Itemp/max(Itemp(:));        plot(ppm1,1*Itemp + (nexp-1),'Color',col_a(npeak,:),'LineWidth',lw_v(npeak))        hold on    endendhold offset(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,...    'Box','off','TickDir','out','Ycolor','none')axis([ppmmin1 ppmmax1 -.2 length(expno)+ .01])xlabel(['\delta(' NMRacqus.nuc2 ') / ppm'])figtrace_fn = fullfile(data_path,expnam,[fignam '_slices1.pdf']);set(gcf, 'PaperUnits','centimeters','PaperPosition', [0 0 papersize_cm],'PaperSize', papersize_cm);set(gcf,'Render','painters')% set(gcf,'color','none','inverthardcopy','off');print(figtrace_fn, '-dpdf', '-loose')for nexp = 1:length(expno)    I = Iarray(:,:,nexp);    Iplot = I; %Iplot(find(Iplot<minI)) = minI;    Iplot = Iplot/maxI;%        Iproj = max(I,[],2); Iproj = Iproj/max(Iproj(find(ppm>ppmmin&ppm<ppmmax)));%        Iproj1 = max(I,[],1); Iproj1 = Iproj1/max(Iproj1(find(ppm1>ppmmin1&ppm1<ppmmax1)));%     Iproj = max(I(:,find(ppm1>ppmmin1&ppm1<ppmmax1)),[],2); Iproj = Iproj/max(Iproj(find(ppm>ppmmin&ppm<ppmmax)));%     Iproj1 = max(I(find(ppm>ppmmin&ppm<ppmmax),:),[],1); Iproj1 = Iproj1/max(Iproj1(find(ppm1>ppmmin1&ppm1<ppmmax1)));    Iproj = max(Iplot(:,find(ppm1>ppmmin1&ppm1<ppmmax1)),[],2);    Iproj1 = max(Iplot(find(ppm>ppmmin&ppm<ppmmax),:),[],1);    Iproj = Iproj/max(Iproj);    Iproj1 = Iproj1/max(Iproj1);    figure(1), clf    axh_txt = axes('position',[0 0 1 1]);    txt_cell = {['expno = ' num2str(expno(nexp))];...        ['d1 = ' num2str(d1_v(nexp)) ' s'];...        ['p15 = ' sprintf('%4.0f',p15_v(nexp)) ' us'];...        ['d8 = ' num2str(d8_v(nexp)*1e3) ' ms']};    t = text(0,1,txt_cell);    t.FontSize = fs; t.Units = 'normalized'; t.HorizontalAlignment = 'left'; t.VerticalAlignment = 'top';    axis(axh_txt,'off')    axes('position',[.2 .15 .7 .65],'FontSize',fs)    contour(ppm,ppm1,Iplot',logspace(log10(Imin),log10(Imax),20),'k','LineWidth',lw_cont)    axis([ppmmin ppmmax ppmmin1 ppmmax1 -.05 1.02])    view(0,90), shading('interp')    set(gca,'XDir','reverse','YDir','reverse','YAxisLocation','right','TickDir','out','Box','on')    grid('off')    set(gca,'LineWidth',lw)    xlabel('\delta(^1^3C) / ppm','FontSize',fs)    ylabel('\delta(^1H) / ppm','FontSize',fs)    hold on    plot3([ppmmax ppmmin ppmmin], [ppmmax1 ppmmax1 ppmmin1], [1 1 1],'k-','LineWidth',lw)    for npeak = 1:Npeaks        plot3(peaks(npeak)*[1 1],[ppmmin1 ppmmax1],[1 1],'Color',col_a(npeak,:),'LineWidth',lw_cont)    end    for npeak1 = 1:Npeaks1        plot3([ppmmin ppmmax],peaks1(npeak1)*[1 1],[1 1],'Color',col_a(npeak1,:),'LineWidth',lw_cont)    end    hold off    axes('position',[.2 .81 .7 .19])%     plot(ppm,Iproj,'k','LineWidth',2*lw)    hold on    for npeak1 = 1:Npeaks1        Itemp = squeeze(peak1_Iproj(:,npeak1,nexp));        Itemp = Itemp/max(Itemp(:));        plot(ppm,Itemp,'Color',col_a(npeak1,:),'LineWidth',lw_v(npeak1))    end    for npeak = 1:Npeaks        plot([peakppmmin(npeak) peakppmmax(npeak)],[0 0],'Color',col_a(npeak,:),'LineWidth',lw_v(npeak))    end    set(gca,'XDir','reverse')    axis([ppmmin ppmmax Imax*[-.02 1.02]])    axis off    axes('position',[.0 .15 .2 .65])%     plot(Iproj1,ppm1,'k','LineWidth',lw)    hold on    for npeak = 1:Npeaks        Itemp = squeeze(peak_Iproj(npeak,:,nexp));        Itemp = Itemp/max(Itemp(:));        plot(Itemp,ppm1,'Color',col_a(npeak,:),'LineWidth',lw_v(npeak))            end    for npeak1 = 1:Npeaks1        plot([0 0],[peakppmmin1(npeak1) peakppmmax1(npeak1)],'Color',col_a(npeak1,:),'LineWidth',lw_v(npeak1))    end    set(gca,'XDir','reverse','YDir','reverse')    axis([Imax*[-.02 1.02] ppmmin1 ppmmax1])    axis off    if MkReportFig        fig_fn = fullfile(data_path,expnam,num2str(expno(nexp)),'ReportFig.pdf');%         delete(fig_fn)                set(gcf, 'PaperUnits','centimeters','PaperPosition', [0 0 papersize],'PaperSize', papersize);%         set(gcf,'color','none','inverthardcopy','off');        set(gcf,'Render','painters')        print(fig_fn, '-dpdf', '-loose')    endpause(1)end%%figtex_fn = fullfile(data_path,expnam,fignam);fidtex = fopen(figtex_fn,'w');fprintf(fidtex,'%s\r','\documentclass{article}');fprintf(fidtex,'%s\r','\usepackage{geometry,graphicx, epstopdf}');fprintf(fidtex,'%s\r',['\geometry{papersize={' num2str(papersize(1)) 'cm,' num2str(papersize(2)) 'cm}, scale=1}']);fprintf(fidtex,'%s\r','\usepackage[abs]{overpic}');fprintf(fidtex,'%s\r\r','\setlength\unitlength{1in}');fprintf(fidtex,'%s\r\r','\begin{document}');for nexp = 1:length(expno)    fig_fn = fullfile(data_path,expnam,num2str(expno(nexp)),'ReportFig.pdf');    fprintf(fidtex,'%s\r','\begin{figure}');    fprintf(fidtex,'%s\r',['  \includegraphics[width=' num2str(papersize(1)) 'cm]{' fig_fn '}']);     fprintf(fidtex,'%s\r\r','\end{figure}');    fprintf(fidtex,'%s\r','\clearpage'); end    fprintf(fidtex,'%s\r','');fprintf(fidtex,'%s\r','\end{document}');fclose(fidtex);