clear allwd = cd;DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/opt/topspin2/data/DT/nmr';cd(DataDir)ExpNam = {'isoDW'};expno = 2:2:12;%expno = [2 4 6 12];expno = 12;signal = 'area';PlotInterm = 0;cd(ExpNam{1})Ythresh = 0.001;%bmax = 5e9;for nexp = 1:length(expno)    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    eval(['load ' num2str(expno(nexp)) '/NMRacqu2s'])    eval(['load ' num2str(expno(nexp)) '/FitDat PP FitDat'])    fs = 20;    lw = 1;        fitpoints = ((PP.td1start+1)/2):(NMRacqu2s.td/2);    iso_indx = ((PP.td1start+1):2:NMRacqu2s.td);    aniso_indx = iso_indx-1;    Xdat = PP.X;        clear FitDat    FitDat.fitpoints = fitpoints;    for npeak = 1:PP.Npeaks        Xin = Xdat(fitpoints);        Xin  = [Xin; Xin];        Yin = [PP.Ipeak(npeak,aniso_indx)'; PP.Ipeak(npeak,iso_indx)'];        if strcmp(signal,'area')==1            Yin = [PP.Apeak(npeak,aniso_indx)'; PP.Apeak(npeak,iso_indx)'];        end        %figure(1), clf, semilogy(Xin,Yin,'o'), return        Pin = [Yin(1)*1.1   7/mean(Xin(:,1))*[1 .7 .01]]; Funam = 'fmuaniso';        Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;         Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,zeros(size(Pin)),[],[],Pnorm,Xnorm,Ynorm);        Yout = feval(Funam,Pout,Xin); error = Yin - Yout;        if PlotInterm            figure(11), clf            axes('position',[.1 .27 .8 .65])            semilogy(Xin,Yin,'o')            hold on            semilogy(Xin,Yout,'-')            title(['expno=' num2str(expno(nexp)) '  peak=' num2str(npeak) '  '  Funam  '   Pout= ' num2str(Pout,3) ])            axis([min(min(Xin)) max(max(Xin)) max(max(Yout))*[1e-3 1.2] ])            xlabel('time'), ylabel('intensity')            axes('position',[.1 .05 .8 .1])            plot(Xin,error,'o'), grid            ylabel('residual')            pause(1)            return        end                fitpoints2 = find(Xin<-log(Ythresh)/Pout(2));        if exist('bmax')==1            fitpoints2 = find(Xin<bmax);        end        Xin = Xin(fitpoints2);        Yin = Yin(fitpoints2);        Pin = [Pout(1:2) Pout(2)/1e2 Pout(2)/8e2]; Funam = 'fmuaniso';        Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;         Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,zeros(size(Pin)),[],[],Pnorm,Xnorm,Ynorm);        Yout = feval(Funam,Pout,Xin); error = Yin - Yout;        if PlotInterm            figure(11), clf            axes('position',[.1 .27 .8 .65])            semilogy(Xin,Yin,'o')            hold on            semilogy(Xin,Yout,'-')            title(['expno=' num2str(expno(nexp)) '  peak=' num2str(npeak) '  '  Funam  '   Pout= ' num2str(Pout,3) ])            axis([min(min(Xin)) max(max(Xin)) max(max(Yout))*[1e-3 1.2] ])            xlabel('time'), ylabel('intensity')            axes('position',[.1 .05 .8 .1])            plot(Xin,error,'o'), grid            ylabel('residual')            pause(1)            return        end                FitDat.Xin{npeak} = Xin;        FitDat.Yin{npeak} = Yin;        FitDat.Yout{npeak} = Yout;        FitDat.Y0(:,npeak) = Pout(1);        FitDat.D(:,npeak) = Pout(2);        FitDat.sigma_aniso(:,npeak) = Pout(3);        FitDat.sigma_iso(:,npeak) = Pout(4);    end     figure(1), clf    axes('position',[0 .18 1 .3],'FontSize',fs*.8)    plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)    set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])    axis('tight')    ylim = get(gca,'YLim');    ylim = .05*diff(ylim)*[-1 1] + ylim;    set(gca,'YLim',ylim)    xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)    hold on    plot(PP.peakppm(:,PP.td1start),PP.Ipeak(:,PP.td1start),'bo','LineWidth',lw)    dleft = 1/PP.Npeaks;    width = .8*dleft;    height = .3;    left = 1-width;    bottom = .6;    if PP.Npeaks == 1, width = .8*1/2; end    for npeak = 1:PP.Npeaks        axes('position',[left bottom width height],'FontSize',fs*.8)        npoints = length(FitDat.Xin{npeak})/2;        semilogy(FitDat.Xin{npeak}(1:npoints),FitDat.Yin{npeak}(1:npoints)/FitDat.Y0(npeak),'bo','LineWidth',lw)        hold on        semilogy(FitDat.Xin{npeak}((npoints+1):(2*npoints)),FitDat.Yin{npeak}((npoints+1):(2*npoints))/FitDat.Y0(npeak),'ro','LineWidth',lw)        semilogy(FitDat.Xin{npeak}(1:npoints),FitDat.Yout{npeak}(1:npoints)/FitDat.Y0(npeak),'b-','LineWidth',lw)        semilogy(FitDat.Xin{npeak}((npoints+1):(2*npoints)),FitDat.Yout{npeak}((npoints+1):(2*npoints))/FitDat.Y0(npeak),'r-','LineWidth',lw)        semilogy([0 max(FitDat.Xin{npeak})],[1 exp(-max(FitDat.Xin{npeak})*FitDat.D(npeak))],'k--','LineWidth',1.5*lw)        axis('tight')        xlabel('b / m^2s^-^1')        ylim = get(gca,'YLim');        %ylim = .05*abs(diff(ylim))*[-1 1] + abs(ylim); ylim(1) = 0;        ylim = ylim(2)*[1e-1 1.1];        xlim = get(gca,'XLim');        xlim = .05*diff(xlim)*[-1 1] + xlim;        set(gca,'XLim',xlim,'YLim',ylim,'YTick',[1e-3 1e-2 1e-1 1],...            'TickDir','out','Box','off','LineWidth',1.5*lw)                D = FitDat.D(npeak)        sigma_aniso = FitDat.sigma_aniso(npeak)        sigma_iso = FitDat.sigma_iso(npeak)        nonGauss = sigma_iso./D;        %muFA = (sigma_aniso-sigma_iso)./D;        %muFA = sqrt(sigma_aniso^2-sigma_iso^2)./D;        muFA = sqrt(3./(2+4/5*D.^2./(sigma_aniso^2-sigma_iso^2)));        title({[num2str(PP.peakppm(npeak,PP.td1start),3) ' ppm'];...            ['D=' num2str(D,2) ' m^2s^-^1 nG=' num2str(nonGauss,2) ' \muFA=' num2str(muFA,2) ]},'FontSize',fs*.5)        left = left-dleft;    end    %pause    delete([num2str(expno(nexp)) '/ReportFig.*'])    eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])end