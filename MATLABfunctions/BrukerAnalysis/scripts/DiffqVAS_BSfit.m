clear allwd = cd;%DataDir = '/Users/daniel/Dropbox';DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/Users/daniel/NMRdata/AVII200/';%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/opt/topspin/data/DT/nmr';ExpNam = 'AOT_1H2H';expno = 196; WaterPeak = 2; FigNam = 'Cub';expno = 171; WaterPeak = 1; FigNam = 'Lam';%expno = 209; WaterPeak = 3; FigNam = 'RevHex';% ExpNam = 'AOT_1H2H_comp';% expno = 8; WaterPeak = 3; FigNam = 'RevHex_2';signal = 'area'; %signal = 'intensity';td1start = 2;MakeBS = 0; %Bootstrap on/offNBS = 10000; %Number of bootstrap samplesConfLev = 0.95; %Confidence levelcd(DataDir)cd(ExpNam)for nexp = 1:length(expno)    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    eval(['load ' num2str(expno(nexp)) '/FitDat'])    if MakeBS        if strcmp(signal,'area')                    S_vector = PP.Apeak(:,WaterPeak);        else            S_vector = PP.Ipeak(:,WaterPeak);        end        Npoints = AcqDat.td1;        Dpar = FitDat.Dpar(WaterPeak);        Dperp = FitDat.Dperp(WaterPeak);        Diso = (Dpar + 2*Dperp)/3;        DeltaD = 1/3/Diso*(Dpar - Dperp);        S0 = max(S_vector);        indx_all_array = repmat((1:Npoints)',[1 Npoints]);        S_array = reshape(S_vector,AcqDat.Nb*AcqDat.NDeltab,AcqDat.Ndir);        Xin = AcqDat.bmat.b(1:AcqDat.Nb*AcqDat.NDeltab);        Xin2 = AcqDat.bmat.Delta(1:AcqDat.Nb*AcqDat.NDeltab);        Pin = [max(S_vector)*1.05 Diso DeltaD]; Funam = 'fDiffVACSY2';        UB = [max(S_vector)*5 3e-9 1];        LB = [max(S_vector)*0.01 1e-11 -0.5];        options = optimset('Display','off');        Pout_array = zeros(NBS,3);        tic        parfor nBS = 1:NBS            %indx_BS = indx_all;            indx_BS = td1start - 1 + sort(ceil((Npoints-td1start+1)*rand(Npoints,1)));            %figure(1), clf, plot(indx_all,indx_BS,'-'), return            indx_BS_array = repmat(indx_BS',[Npoints 1]);            PAweight = 1e-3 + sum(indx_all_array == indx_BS_array,2);            %figure(1), clf, plot(indx_all,PAweight,'-'), return            PAweight_array = reshape(PAweight,AcqDat.Nb*AcqDat.NDeltab,AcqDat.Ndir);            S_PA = sum(S_array.*PAweight_array,2)./sum(PAweight_array,2);            %figure(1), clf, plot(1:AcqDat.Nb*AcqDat.NDeltab,S_PA,'o'), return            Yin = S_PA;             %figure(1), clf, semilogy(Xin,Yin,'o'), return                Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = abs(Pin);             Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,options,Xin2,Pnorm,Xnorm,Ynorm);            Yout = feval(Funam,Pout,Xin,Xin2); error = Yin - Yout;            %figure(1), clf, semilogy(Xin,Yin,'o',Xin,Yout,'x'), return            Pout_array(nBS,:) = Pout;        end        toc        %%        BSdat.NBS = NBS;        BSdat.S0 = Pout_array(:,1);        BSdat.Diso = Pout_array(:,2);        BSdat.DeltaD = Pout_array(:,3);        BSdat.Dpar = BSdat.Diso.*(1 + 2*BSdat.DeltaD);        BSdat.Dperp = BSdat.Diso.*(1 - BSdat.DeltaD);    else        eval(['load ' num2str(expno(nexp)) '/BSdat'])    end        figure(3), clf    Nx = 3; Ny = 2;    ParNam = {'S0','DeltaD','Diso','Dpar','Dperp'};    for nsub = 1:length(ParNam)        subplot(Ny,Nx,nsub)        eval(['histdat = BSdat.' ParNam{nsub} ';'])        histdat = sort(histdat);        minlim = histdat(floor((1-ConfLev)/2*BSdat.NBS));        maxlim = histdat(ceil((1-(1-ConfLev)/2)*BSdat.NBS));        meanval = mean(histdat);        hist(histdat)               title([ ParNam{nsub} '=' num2str(meanval,4) '\pm' num2str((maxlim-minlim)/2,3)])    end        eval(['save ' num2str(expno(nexp)) '/BSdat BSdat'])    eval(['print -depsc -loose ' num2str(expno(nexp)) '/BSFig'])    end                            %%        