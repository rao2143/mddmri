clear allwd = cd;DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/opt/topspin2/data/DT/nmr';cd(DataDir) ExpNam = {'isoaniso_test'}; expno = 85;ExpNam = {'isoanisocorr_qMASopt'}; expno = 6;basl = [.03 .2 .8 .97]; lb = 20; si = 4*1024;%ll = 1959; ul = 2307;AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 1;PlotInterm = 0;thresh = .06;td1start = 2;signal = 'area';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_pgseisoaniso','DT_isoanisoqMASopt'})) == 1        Spec2Dtd1        if AutoPhaseAll            AutoPhasetd1        end        PeakPick        gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        end        fid = fopen([num2str(expno(nexp)) '/diff_ramp.txt']);        difframp = fscanf(fid,'%f');        fclose(fid);        G.x = 0*difframp*Gmax.*NMRacqus.cnst1/100;        G.y = difframp*Gmax.*NMRacqus.cnst2/100;        G.z = 0*difframp*Gmax.*NMRacqus.cnst3/100;        G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);        Gnorm.x = G.x./G.r;        Gnorm.y = G.y./G.r;        Gnorm.z = G.z./G.r;        if any(strcmp(NMRacqus.pulprog,{'DT_pgseisoaniso'})) == 1            delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;            Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p2/1e6;            tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        end        PP.X = b;%%        Xdat = b;        fitpoints = PP.td1start:length(b);        ExpFit            fs = 20;        lw = 1;        figure(1), clf        axes('position',[0 .18 1 .3],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .05*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        hold on        plot(PP.peakppm(:,PP.td1start),PP.Ipeak(:,PP.td1start),'bo','LineWidth',lw)        dleft = 1/Npeaks;        width = .8*dleft;        height = .3;        left = 1-width;        bottom = .6;        if Npeaks == 1, width = .8*1/2; end        for npeak = 1:Npeaks            axes('position',[left bottom width height],'FontSize',fs*.8)            semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo','LineWidth',lw)            hold on            semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k-','LineWidth',lw)            if strcmp(signal,'area')==1                Ydat = reshape(PP.Apeak(npeak,:),sqrt(NMRacqu2s.td),sqrt(NMRacqu2s.td));                semilogy(FitDat.Xin(:,npeak),Ydat(1,fitpoints)'/FitDat.Y0(npeak),'ro','LineWidth',lw)            else                Ydat = reshape(PP.Ipeak(npeak,:),sqrt(NMRacqu2s.td),sqrt(NMRacqu2s.td));                semilogy(FitDat.Xin(:,npeak),Ydat(fitpoints,1)'/FitDat.Y0(npeak),'ro','LineWidth',lw)            end                        axis('tight')            xlabel('b / m^-^2s')            ylim = get(gca,'YLim');            %ylim = .05*abs(diff(ylim))*[-1 1] + abs(ylim); ylim(1) = 0;            ylim = ylim(2)*[1e-3 1.2];            xlim = get(gca,'XLim');            xlim = .05*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,'YTick',[1e-3 1e-2 1e-1 1],...                'TickDir','out','Box','off','LineWidth',1.5*lw)            title({[num2str(PP.peakppm(npeak,PP.td1start),3) ' ppm'];...                [num2str(FitDat.R(npeak),3) ' m^2s^-^1']},'FontSize',fs*.5)            left = left-dleft;        end        eval(['save ' num2str(expno(nexp)) '/FitDat PP FitDat'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])        %eval(['save ' num2str(expno(nexp)) '/FitDat PP'])    endend