clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/Users/daniel/NMRdata/AVII200/';%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/opt/topspin/data/DT/nmr';cd(DataDir)ExpNam = {'DiffCR_setup'}; expno = 13;basl = [.05 .3 .7 .95]; lb = 200; si = 2*1024;AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .1;td1start = 1;Imin = 1e-2;signal = 'area'; %signal = 'intensity';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'Y';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_GS2'})) == 1                Spec2Dtd1        PeakPick        Xdat = NMRacqus.vd;        Xdat2 = NMRacqus.d2 + NMRacqus.in2*(0:(NMRacqus.l2-1));        [Xdat,Xdat2] = ndgrid(Xdat,Xdat2);        Xdat = reshape(Xdat,numel(Xdat),1);        Xdat2 = reshape(Xdat2,numel(Xdat2),1);        PP.X = NMRacqus.vd;        eval(['save ' num2str(expno(nexp)) '/PeakDat PP'])        fitpoints = td1start:NMRacqu2s.td;        FitDat.fitpoints = fitpoints;        FitDat.signal = signal;        for npeak = 1:Npeaks            Xin = Xdat(fitpoints);            Xin2 = Xdat2(fitpoints);            Yin = PP.Ipeak(fitpoints,npeak);            if strcmp(signal,'area')==1                Yin = PP.Apeak(fitpoints,npeak);            end            %figure(1), clf, semilogx(Xin,Yin,'o'), return            Pin = [max(Yin) 100 100 1 1 300 300]; Funam = 'fGS';            LB = [0 0 0 0 -10 0 0];            UB = [2*max(Yin) 1000 1000 500 500 1000 1000];            Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;             Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB,UB,[],Xin2,Pnorm,Xnorm,Ynorm); %Matlab 6            Yout = feval(Funam,Pout,Xin,Xin2,ones(size(Pin)),1,1); error = Yin - Yout;            Ycalc = feval(Funam,Pout,Xdat,Xdat2,ones(size(Pin)),1,1);            %figure(3), clf, plot(1:td1,Yin,'o',1:td1,Ycalc,'-'), return                        FitDat.Xin(:,npeak) = Xin;            FitDat.Xin2(:,npeak) = Xin2;            FitDat.Yin(:,npeak) = Yin;            FitDat.Ycalc(:,npeak) = Ycalc;            FitDat.Yout(:,npeak) = Yout;            FitDat.Y0(1,npeak) = Pout(1);            FitDat.kw(1,npeak) = Pout(2);            FitDat.ks(1,npeak) = Pout(3);            FitDat.R1w(1,npeak) = Pout(4);            FitDat.R1s(1,npeak) = Pout(5);            FitDat.wL(1,npeak) = Pout(6);            FitDat.wG(1,npeak) = Pout(7);        end                FitDat.C = FitDat.kw + FitDat.R1w - FitDat.ks - FitDat.R1s;        FitDat.Rplus = 0.5*(FitDat.kw+FitDat.R1w+FitDat.ks+FitDat.R1s+sqrt(FitDat.C.^2 + 4*FitDat.kw*FitDat.ks));        FitDat.Rminus = 0.5*(FitDat.kw+FitDat.R1w+FitDat.ks+FitDat.R1s-sqrt(FitDat.C.^2 + 4*FitDat.kw*FitDat.ks));        FitDat.Tcr = (FitDat.kw + FitDat.ks)./(FitDat.kw.*FitDat.ks);        FitDat.pw = FitDat.ks./(FitDat.kw + FitDat.ks);        fs = 20;        lw = 1;%%        figure(1), clf        axes('position',[-.01 .15 1.02 .35],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .05*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        hold on        plot(PP.peakppm(td1start,:),PP.Ipeak(td1start,:),'bo','LineWidth',lw)        plot(PP.ppm,-1*ylim(1)+50*PP.Ispec,'k','LineWidth',.5*lw)        plot(PP.peakppm(td1start,:),-1*ylim(1)+50*PP.Ipeak(td1start,:),'bo','LineWidth',lw)        dleft = (1-.1)/Npeaks;        width = .9*dleft;        height = .3;        left = 1-width;        bottom = .6;        if Npeaks == 1, width = .8*1/2; end        for npeak = 1:Npeaks            axes('position',[left bottom width height],'FontSize',fs*.8)            semilogx(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo')            hold on            %semilogx(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k--','LineWidth',lw)            axis('tight')            ylim = get(gca,'YLim');            %ylim = .05*abs(diff(ylim))*[-1 1] + abs(ylim); ylim(1) = 0;            ylim = ylim(2)*[-.1 1.1];            set(gca,'XLim',xlim,'YLim',ylim,...                'TickLength',.02*[1 1],'TickDir','out','Box','off','YMinorTick','on','LineWidth',1.5*lw)            set(gca,'YTick',[0 .5 1])            set(gca,'XTick',[1e-3 1e-2 1e-1 1 10])                                                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...            ['p_w=' num2str(FitDat.pw(npeak),2) ' T_c_r=' num2str(FitDat.Tcr(npeak)*1e3,2) 'ms'...            ' T_1=' num2str(1./FitDat.Rminus(npeak),2) 's']},'FontSize',fs*.5)            left = left-dleft;                        Iplot = reshape(FitDat.Ycalc(:,npeak),length(PP.X),NMRacqu2s.td/length(PP.X));            semilogx(PP.X,Iplot/FitDat.Y0(npeak),'-k')            xlim = [min(PP.X)/2 max(PP.X)*2];            set(gca,'XLim',xlim,'XScale','log')            if npeak < Npeaks                set(gca,'XTick',[],'YTick',[])            end        end               %%        eval(['save ' num2str(expno(nexp)) '/FitDat FitDat'])        ReportFigCaption = [            ' kw=' num2str(Pout(2),3) ' ks=' num2str(Pout(3),3)...            ' R1w=' num2str(Pout(4),3) ' R1s=' num2str(Pout(5),3) ...            ' C=' num2str(Pout(2)-Pout(3)+Pout(4)-Pout(5),3)...            ' kwks=' num2str(Pout(2)*Pout(3),3)];        eval(['save ' num2str(expno(nexp)) '/ReportFigCaption ReportFigCaption'])    endend