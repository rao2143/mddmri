clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT/';DataDir = '/Users/daniel/NMRdata/AVII200/';%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/opt/topspin/data/DT/nmr';cd(DataDir)ExpNam = {'Starch_DRcorr'}; expno = 88; BiexpFitFlag = 1;basl = [.05 .45 .55 .95];skip = [0.07 0.08 0.39 0.4 0.44 0.45];AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .1;td1start = 1;Imin = 1e-1;signal = 'area'; signal = 'intensity';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_pgsetm'})) == 1        Spec2Dtd1        if AutoPhaseAll            AutoPhasetd1        end        %%        indx = 1:100;        indx1 = (1:16) + 50*16;        figure(1), clf        plot(t(indx),abs(Std1(indx,indx1)))        return        %%                PeakPick        gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        elseif any(strcmp(NMRacqus.probhd,{'5 mm Diff25 1H Z-GRD H7979/10'})) == 1            Gmax = 9.6;            NMRacqus.cnst1 = 0;            NMRacqus.cnst2 = 0;                   end        fid = fopen([num2str(expno(nexp)) '/diff_ramp.txt']);        difframp = fscanf(fid,'%f');        fclose(fid);        G.x = difframp*Gmax.*NMRacqus.cnst1/100;        G.y = difframp*Gmax.*NMRacqus.cnst2/100;        G.z = difframp*Gmax.*NMRacqus.cnst3/100;        G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);        Gnorm.x = G.x./G.r;        Gnorm.y = G.y./G.r;        Gnorm.z = G.z./G.r;        delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;        Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p2/1e6;        tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;        q = gamma*G.r*delta/2/pi;        b = (2*pi*q).^2*tdiff;        PP.X = b;        eval(['save ' num2str(expno(nexp)) '/PeakDat PP'])        Xdat = b;        fitpoints = td1start:length(Xdat);                if BiexpFitFlag            BiexpFit        else            ExpFit        end        fs = 20;        lw = 1;        %%        figure(1), clf        axes('position',[-.01 .15 1.02 .35],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .05*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        hold on        plot(PP.peakppm(td1start,:),PP.Ipeak(td1start,:),'bo','LineWidth',lw)        plot(PP.ppm,-1*ylim(1)+50*PP.Ispec,'k','LineWidth',.5*lw)        plot(PP.peakppm(td1start,:),-1*ylim(1)+50*PP.Ipeak(td1start,:),'bo','LineWidth',lw)        dleft = (1-.1)/Npeaks;        width = .9*dleft;        height = .3;        left = 1-width;        bottom = .6;        if Npeaks == 1, width = .8*1/2; end        for npeak = 1:Npeaks            axes('position',[left bottom width height],'FontSize',fs*.8)            semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo')            hold on            semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k--','LineWidth',lw)            axis('tight')            ylim = get(gca,'YLim');            %ylim = .05*abs(diff(ylim))*[-1 1] + abs(ylim); ylim(1) = 0;            ylim = ylim(2)*[Imin 1.2];            xlim = get(gca,'XLim');            xlim = .05*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,...                'TickLength',.02*[1 1],'TickDir','out','Box','off','YMinorTick','on','LineWidth',1.5*lw)            set(gca,'YTick',[1e-3 1e-2 1e-1 1])            %set(gca,'XTick',[1e7 1e8 1e9 1e10 1e11])            if BiexpFitFlag                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                [num2str(FitDat.Pfast(npeak),3)]},'FontSize',fs*.5)            else                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                [num2str(FitDat.R(npeak),3) ' m^2s^-^1']},'FontSize',fs*.5)            end            left = left-dleft;            if any(strcmp(NMRacqus.pulprog,{'DT_fexsy3'})) == 1                Iplot = reshape(PP.Ipeak(:,npeak),length(PP.X),NMRacqu2s.td/length(PP.X));                if strcmp(FitDat.signal,'area')==1                            Iplot = reshape(PP.Apeak(:,npeak),length(PP.X),NMRacqu2s.td/length(PP.X));                end                semilogy(PP.X,Iplot/FitDat.Y0(npeak),'-bo')                semilogy(PP.X,Iplot(:,1)/FitDat.Y0(npeak),'-ko')                semilogy(PP.X,Iplot(:,2)/FitDat.Y0(npeak),'-ro')            end            xlim = [min(PP.X)/2 max(PP.X)*2];            %set(gca,'XLim',xlim,'XScale','log')            if npeak < Npeaks                set(gca,'XTick',[],'YTick',[])            end        end               %%        eval(['save ' num2str(expno(nexp)) '/FitDat FitDat'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])    endend