clear allticwd = cd;cd(['/Users/daniel/NMRdata/AVII500/DT/'])%cd('/Users/daniel/Dropbox')% ExpNam = {'AOT_1H2H'};% expno = 142; phc0 = -16; phc1 = 0;% expno = 166; phc0 = -25; phc1 = 0; FIDeff = .7;% basl = [.04 .17 .83 .96];% %si = 4*1024;% lb = 50;% %si1 = 128;% lb1 = 3e-4;% ExpNam = {'AOToct'};% expno = 105; AutoPhase = 0; phc0 = 340; phc1 = 0; FIDeff = .95;% expno = 115; AutoPhase = 0; phc0 = 340; phc1 = 0; FIDeff = .95;% basl = [.04 .17 .83 .96];% lb = 20; lb1 = 3e-4;% % ExpNam = {'AOToct2'};% expno = 16; AutoPhase = 1;% %expno = 17; AutoPhase = 1; phc0 = 340; phc1 = 0;% basl = [.04 .17 .83 .96];%lb = 5; lb1 = 3e-4;% ExpNam = {'AOToct3'};% expno = 14; AutoPhase = 1;% %expno = 17; AutoPhase = 1; phc0 = 340; phc1 = 0;% basl = [.04 .17 .83 .96];% lb = 5; lb1 = 3e-4;ExpNam = {'C14E5_3'};expno = 10; AutoPhase = 1; %phc0 = 140; phc1 = 0;expno = 29; AutoPhase = 0; phc0 = 140; phc1 = 0;expno = 33; AutoPhase = 0; phc0 = 330; phc1 = -90;basl = [.03 .15 .85 .97];lb = 5; lb1 = 3e-4;CheckBasline = 0;AutoPhaseAll = 0;LoadSer = 1;cd(ExpNam{1})for nexp = 1:length(expno)    ConvertAcqus = 'N';        ConvertProcs = 'N';       MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    if exist([num2str(expno(nexp)) '/pdata/1/NMRprocs.mat']) == 0        ConvertProcs = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        load([num2str(expno(nexp)) '/NMRacqus.mat'])    load([num2str(expno(nexp)) '/pdata/1/NMRprocs.mat'])    eval(['load ' num2str(expno(nexp)) '/NMRacqu2s'])    load([num2str(expno(nexp)) '/pdata/1/NMRproc2s.mat'])           gamma = 26.75e7;    if strcmp(NMRacqus.nuc1,'2H')        gamma = 4.11e7;    elseif strcmp(NMRacqus.nuc1,'7LI')        gamma = 10.398e7;    elseif strcmp(NMRacqus.nuc1,'23NA')        gamma = 7.0761e7;    end    Gmax = 9.6;    if any(strcmp(NMRacqus.probhd,{'5 mm DIF-30 2H-1H Z-GRD Z3886/0018',...            '5 mm DIF-30 BB-1H Z-GRD Z3886/0018',...            'diff30 z-Gradient Probe MIC Z3386/0017'})) == 1        Gmax = 18*sqrt(1.9e-09/1.9e-9);    elseif any(strcmp(NMRacqus.probhd,{'5 mm MIC BB-1H XYZ-GRD Z3386/0019'})) == 1        Gmax = 3*sqrt(1.9e-09/1.9e-9);    end        delta = NMRacqus.d2+NMRacqus.d3;    tau = NMRacqus.d2 + NMRacqus.d3 + NMRacqus.d2 + NMRacqus.d4;    G.x = linspace(-1,1,NMRacqus.l1+1)'*Gmax*NMRacqus.cnst21/100; G.x = G.x(1:NMRacqus.l1);    G.y = linspace(-1,1,NMRacqus.l2+1)'*Gmax*NMRacqus.cnst22/100; G.y = G.y(1:NMRacqus.l2);    G.z = linspace(-1,1,NMRacqus.l3+1)'*Gmax*NMRacqus.cnst23/100; G.z = G.z(1:NMRacqus.l3);    k.x = gamma*G.x'*delta/2/pi;    k.y = gamma*G.y'*delta/2/pi;    k.z = gamma*G.z'*delta/2/pi;        lbfunz = exp(-(lb1*pi*k.z).^2);    lbfunx = exp(-(lb1*pi*k.x).^2);    %figure(1), clf, plot(k.z,lbfunz,'o',k.x,lbfunx,'s'), return    if exist('six') == 0, six = NMRacqus.l1; end    if exist('siy') == 0, siy = NMRacqus.l2; end    if exist('siz') == 0, siz = NMRacqus.l3; end    r.x = .5/(k.x(2)-k.x(1))*linspace(-1,1,six+1); r.x = r.x(1:six);    r.y = .5/(k.y(2)-k.y(1))*linspace(-1,1,siy+1); r.y = r.y(1:siy);    r.z = .5/(k.z(2)-k.z(1))*linspace(-1,1,siz+1); r.z = r.z(1:siz);        resolution.x = abs(r.x(2)-r.x(1));    resolution.y = abs(r.y(2)-r.y(1));    resolution.z = abs(r.z(2)-r.z(1));    if LoadSer        Spec2Dtd1                si = numel(Itd1(:,1));            Itemp = reshape(Itd1,si,NMRacqus.l3,NMRacqus.l2,NMRacqus.l1);                Ibasl = mean(Itemp(baslpoints,:,:,:),1);        [dummy,Ibasl] = ndgrid(nu,Ibasl);        Ibasl = reshape(Ibasl,si,siz,siy,six);        Itemp = Itemp - Ibasl;                [karray.nu,karray.z,karray.y,karray.x] = ndgrid(nu,k.z,k.y,k.x);        lbfun1 = exp(-lb1.^2*pi.^2*(karray.z.^2 + karray.y.^2 + karray.x.^2));                Itemp = Itemp.*lbfun1;        Itemp = fftshift(fft(ifftshift(Itemp,2),[],2),2);        Itemp = fftshift(fft(ifftshift(Itemp,3),[],3),3);        I = fftshift(fft(ifftshift(Itemp,4),[],4),4);                Ibasl = mean(I(baslpoints,:,:,:),1);        [dummy,Ibasl] = ndgrid(nu,Ibasl);        Ibasl = reshape(Ibasl,si,siz,siy,six);        I = I - Ibasl;        %         if strcmp(NMRacqus.pulprog,'DT_imse3dcs')%             I = flipdim(flipdim(flipdim(I,4),3),2);%         end        clear lbfun td1count zeroshiftfun phcorrfun Itemp Itd1 Std1 Stemp S lbfun1 karray%%        if AutoPhaseAll            for nz = 1:siz                for ny = 1:siy                    for nx = 1:six                                    Itemp = squeeze(I(:,nz,ny,nx));                        %figure(1), clf, plot(real(Itemp)), cd .., return%                         pivot = max(find(abs(Itemp) == max(abs(Itemp))))/si;%                         pivotpoint = round(pivot*si);                        Itemp0 = Itemp;                        Pout = fminsearch('entropy_fun4',[10],[],Itemp0,baslpoints,pivotpoint);                        if any([isnan(Pout)==1])                            Pout = [0];                        end                        phc0=Pout(1);                        phc1=0;                        phcorrfun = exp(i*phc0*pi/180*ones(si,1)+phc1*pi/180*((1:si)'-pivotpoint)./si);                        Itemp = Itemp0.*phcorrfun;                        Itemp = Itemp - mean(Itemp(baslpoints));                        %if strcmp(CheckPhaseshift,'Y') == 1                            figure(1), clf                            subplot(2,1,1)                            plot((1:si)/si,real(Itemp),pivotpoint/si,0,'ro')                            set(gca,'XDir','reverse')                            title([num2str(nz) ' ' num2str(ny) ' ' num2str(nx)])                            subplot(2,1,2)                            plot((1:si)/si,real(Itemp),pivotpoint/si,0,'ro',baslpoints/si,zeros(size(baslpoints)),'r.')                            axis([0 1 min(real(Itemp)) max(real(Itemp))*.05])                            set(gca,'XDir','reverse')                            pause(.1)                            %return                        %end                        I(:,nz,ny,nx) = Itemp;                                           end                end            end        end        r.nu = nu;%%        eval(['save ' num2str(expno(nexp)) '/Idat I r'])    end%%                eval(['load ' num2str(expno(nexp)) '/Idat'])            %indexnu = [1:20 (si-20):si];    %I(indexnu,:,:,:) = 0;    dnu = abs(r.nu(2)-r.nu(1));    I = real(I);    %figure(1), clf, plot(r.nu,I(:,18,7,7),'-'), return    Izyx = squeeze(sum(I,1)*dnu);    I2zyx = squeeze(sum(I.^2,1)*dnu);    Inuz = squeeze(sum(sum(I,4),3));    Inutot = squeeze(sum(sum(sum(I,4),3),2));        %figure(1), clf, plot(r.nu,Inuz(:,18),'-'), return    si = numel(I,:,1);    indexnu = round(1.1*si/2):round(.9*si);    indexz = [1:round(.9*length(r.z)/2) round(1.1*length(r.z)/2):length(r.z)];    indexy = [1:round(.9*length(r.y)/2) round(1.1*length(r.y)/2):length(r.y)];    indexx = [1:round(.9*length(r.x)/2) round(1.1*length(r.x)/2):length(r.x)];    Imax = max(real(reshape(I(indexnu,indexz,indexy,indexx),numel(I(indexnu,indexz,indexy,indexx)),1)));    %Imax = .5e8;        Izyxmax = max(real(reshape(Izyx(indexz,indexy,indexx),numel(Izyx(indexz,indexy,indexx)),1)));    Inuzmax = max(real(reshape(Inuz,numel(Inuz),1)));    Inutotmax = max(real(reshape(Inutot,numel(Inutot),1)));%%    [rarray.nu,rarray.z,rarray.y,rarray.x] = ndgrid(r.nu,r.z,r.y,r.x);    [dummy,Izyx4D] = ndgrid(r.nu,Izyx);    Izyx4D = reshape(Izyx4D,si,siz,siy,six);    Inorm = I./Izyx4D;        Ezyx = squeeze(sum(Inorm.^2,1)*dnu);    M1zyx = squeeze(sum(Inorm.*rarray.nu,1)*dnu);    [dummy,M1zyx4D] = ndgrid(r.nu,M1zyx);    M1zyx4D = reshape(M1zyx4D,si,siz,siy,six);    M2zyx = squeeze(sum(Inorm.*(rarray.nu-M1zyx4D).^2*dnu,1));     thresh = .1;    indexout = find(Izyx<thresh*Izyxmax);%     Izyx(indexout) = 0;     Ezyx(indexout) = 0;     M1zyx(indexout) = 0;     M2zyx(indexout) = 0;    sqrtEzyx = real(sqrt(Ezyx));    sqrtM2zyx = real(sqrt(M2zyx));    eval(['save ' num2str(expno(nexp)) '/Izyxdat Izyx r sqrtEzyx sqrtM2zyx'])%%        if exist([num2str(expno(nexp)) '/Frames']) == 7        rmdir([num2str(expno(nexp)) '/Frames'],'s');    end            res = mkdir([num2str(expno(nexp)) '/Frames/']);    for nz = 1:siz%         for nz = 1:1            %nz = 1         %nz = 32;         ny = siy/2+1;        Inuyx = squeeze(I(:,nz,:,:));        Iyx = squeeze(Izyx(nz,:,:));        Inu = Inuz(:,nz);        figure(1), clf        axes('position',[0 0 1 1])        V = real(Iyx)/Izyxmax;        X = 1e3*squeeze(rarray.x(1,nz,:,:));        Y = 1e3*squeeze(rarray.y(1,nz,:,:));        Z = 1e3*squeeze(rarray.z(1,nz,:,:));        p2 = surf(X,Y,Z,V);        shading(gca,'flat')        colormap('gray'), caxis([0 1])        hold on                Izx = squeeze(Izyx(:,ny,:));        X = 1e3*squeeze(rarray.x(1,:,ny,:));        Y = 1e3*squeeze(rarray.y(1,:,ny,:));        Z = 1e3*squeeze(rarray.z(1,:,ny,:));        p3 = surf(X,Y,Z,Izx/Izyxmax);        shading(gca,'flat')        colormap('gray'), caxis([0 1])                axis equal, axis off        eval(['print ' num2str(expno(nexp)) '/Frames/IsosurfFrame' num2str(nz) ' -djpeg -r300 -loose'])%%        figure(2), clf        sizetot = 0.8;        widthtot = sizetot*8/11;        heighttot = sizetot;        width=widthtot/six;        height = heighttot/siy;        left = (1-widthtot)-.01;        bottom1 = .5*(1-sizetot);                nxy = linspace(0,1,siy*six);        [dummy,nxy] = ndgrid(1:si,nxy);        axes('position',[-.01 .1 .35 .4])        plot(r.nu/1e3,.1+.5*real(Inutot)/Inutotmax,'-k',r.nu/1e3,.5*real(Inu)/Inuzmax,'-b')        xlabel('\nu / kHz')        axis tight        YLim = [-.05 .65];        XLim = get(gca,'XLim');        XLim = XLim + .1*(max(XLim)-min(XLim))*[-1 1];        set(gca,'XDir','reverse','Box','off','TickDir','out','YLim',YLim,'XLim',XLim,'YTick',[],'LineWidth',1)           axes('position',[left bottom1 widthtot heighttot])        clim = [0 1]; colormap('gray')        imagesc(r.x*1e3,r.y*1e3,Iyx/Izyxmax,clim)        set(gca,'YDir','normal')        xlabel('x / mm'), ylabel('y / mm')        title(['z = ' num2str(r.z(nz)*1e3,2) ' mm'])        %figure(1), clf        for nx = 1:six            bottom = bottom1;            for ny = 1:siy                axes('position',[left bottom width height])                %plot(r.nu,.1+real(Inutot)/Inutotmax,'-r',r.nu,real(squeeze(Inuyx(:,ny,nx))/Imax),'-b')                plot(r.nu,1*real(squeeze(Inuyx(:,ny,nx))/Imax),'-b','LineWidth',.1);                axis tight, axis off                set(gca,'XDir','reverse','YLim',[-.02, 1.02],'XLim',.52*NMRacqus.sw_h*[-1 1])%                 set(gca,'XLim',.52*NMRacqus.sw_h*[.1 .5])                bottom = bottom + height;                %pause(.1)                            end            left= left+width;        end %%        pause(.1)        eval(['print ' num2str(expno(nexp)) '/Frames/Frame' num2str(nz) ' -depsc2 -loose'])        if nz == (siz/2+1)            delete([num2str(expno(nexp)) '/ReportFig.*'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            delete([num2str(expno(nexp)) '/*.eps'])            eval(['print ' num2str(expno(nexp)) '/ReportFig -depsc2 -loose'])        end            %        return    end    fidtex = fopen([num2str(expno(nexp)) '/CS3Dimag_slices.tex'],'w');    fprintf(fidtex,'%s\r','\documentclass{article}');    fprintf(fidtex,'%s\r','\usepackage{geometry,graphicx, epstopdf}');    fprintf(fidtex,'%s\r','\geometry{papersize={11in,8in}, scale=1}');    fprintf(fidtex,'%s\r','\usepackage[abs]{overpic}');    fprintf(fidtex,'%s\r\r','\setlength\unitlength{1in}');    fprintf(fidtex,'%s\r\r','\begin{document}');    for nz = 1:siz%         fprintf(fidtex,'%s\r','\begin{figure}');%         fprintf(fidtex,'%s\r',['  \includegraphics[width=11in]{Frames/Frame' num2str(nz) '}']); %         fprintf(fidtex,'%s\r\r','\end{figure}');%         fprintf(fidtex,'%s\r','\clearpage');         fprintf(fidtex,'%s\r','\begin{overpic}[width=11in]');        fprintf(fidtex,'%s\r',['    {Frames/Frame' num2str(nz) '}']);         fprintf(fidtex,'%s\r','\put(1.15,4){\includegraphics[trim = 12in 0in 12in 0in, clip, height=4in]');        fprintf(fidtex,'%s\r',['    {Frames/IsosurfFrame' num2str(nz) '}}']);         fprintf(fidtex,'%s\r\r','\end{overpic}');        fprintf(fidtex,'%s\r','\clearpage');     end        fprintf(fidtex,'%s\r','');    fprintf(fidtex,'%s\r','\end{document}');    fclose(fidtex);    endtoc