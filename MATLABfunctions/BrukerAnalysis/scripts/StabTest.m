clear allwd = cd;%cd(['/opt/topspin/data/DT/nmr']);%cd(['/opt/topspin2/data/DT/nmr']);%cd(['/Users/daniel/NMRdata/AVII200/'])cd('/Users/daniel/Dropbox/NMRdata/AVII500')%ExpNam = {'StabTest131102'}; %expno = 104;%ExpNam = {'Spindiff'}; %expno = 104;%ExpNam = {'qVAS_Starch'};ExpNam = {'He_StabTest_20170227'};%basl = [.05 .2 .8 .95];lb = 20;%si = 64*1024;%ppmshift = 0;%ll = [4085 4240]; ul = [4111 4250];   AutoPhase = 1;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .1;td1start = 3;signal = 'area'; signal = 'intensity';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendIvstime = [1];time = [0];for nexp = 1:length(expno)    ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_zgt'})) == 1        Spec2Dtd1                PeakPick        fitpoints = td1start:NMRacqu2s.td;        Xdat = 1:NMRacqu2s.td;        clear FitDat        FitDat.fitpoints = fitpoints;        FitDat.signal = signal;        for npeak = 1:Npeaks            Xin = Xdat(fitpoints);            Yin = PP.Ipeak(fitpoints,npeak);            if strcmp(signal,'area')==1                Yin = PP.Apeak(fitpoints,npeak);            end            %figure(1), clf, semilogy(Xin,Yin,'o'), return            Y0 = mean(Yin); Funam = 'fconst';            Yout = ones(size(Yin))*Y0; error = Yin - Yout;            if PlotInterm                figure(1), clf                axes('position',[.1 .27 .8 .65])                semilogy(Xin,Yin,'o',Xin,Yout)                title(['expno=' num2str(expno(nexp)) '  peak=' num2str(npeak) '  '  Funam  '   Pout= ' num2str(Pout,3) ])                axis([min(Xin) max(Xin) max(Yout)*[1e-3 1.2] ])                xlabel('time'), ylabel('intensity')                axes('position',[.1 .05 .8 .1])                plot(Xin,error,'o'), grid                ylabel('residual')                pause(1)                %return            end            FitDat.Xin(:,npeak) = Xin;            FitDat.Yin(:,npeak) = Yin;            FitDat.Yout(:,npeak) = Yout;            FitDat.Y0(:,npeak) = Y0;            FitDat.Y0std(:,npeak) = std(error)/Y0;            Yin = PP.peakppm(fitpoints,npeak);            Y0 = mean(Yin);            Yout = ones(size(Yin))*Y0; error = Yin - Yout;            FitDat.ppmin(:,npeak) = Yin;            FitDat.ppmout(:,npeak) = Yout;            FitDat.ppm0(:,npeak) = Y0;            FitDat.ppmstd(:,npeak) = std(error);       end     %%            fs = 20;        lw = 1;        figure(1), clf        axes('position',[-.02 .12 1.02 .25],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .05*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        hold on        plot(PP.peakppm(PP.td1start,:),PP.Ipeak(PP.td1start,:),'bo','LineWidth',lw)        dleft = .93/Npeaks;        width = .9*dleft;        height = .2;        left = 1-width;        bottom1 = .7;        bottom2 = .48;        if Npeaks == 1, width = .8*1; end        for npeak = 1:Npeaks            axes('position',[left bottom1 width height],'FontSize',fs*.5)            plot(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'b-','LineWidth',.5*lw)            hold on            plot(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k-','LineWidth',lw)            axis('tight')            ylim = get(gca,'YLim');            ylim = .1*max([diff(ylim) .1])*[-1 1] + ylim;            xlim = get(gca,'XLim');            xlim = .1*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,'Box','off',...                'TickDir','out','TickLength',.01*[1 1],'Box','off','LineWidth',1.5*lw)            if npeak == Npeaks                ylabel('I / I_0','FontSize',fs*.6)                set(gca,'XTickLabel',[])            end            if npeak < Npeaks                set(gca,'XTickLabel',[])            end            title({['\delta=' num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                ['I/I_0 \pm' num2str(FitDat.Y0std(npeak),2) '  \Delta\delta \pm' num2str(FitDat.ppmstd(npeak),2)]},'FontSize',fs*.5)            axes('position',[left bottom2 width height],'FontSize',fs*.5)            plot(FitDat.Xin(:,npeak),FitDat.ppmin(:,npeak)-FitDat.ppm0(npeak),'b-','LineWidth',.5*lw)            hold on            plot(FitDat.Xin(:,npeak),FitDat.ppmout(:,npeak)-FitDat.ppm0(npeak),'k-','LineWidth',lw)            axis('tight')            ylim = get(gca,'YLim');            ylim = .1*max([diff(ylim) .1])*[-1 1] + ylim;            xlim = get(gca,'XLim');            xlim = .1*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,'Box','off',...                'TickDir','out','TickLength',.01*[1 1],'Box','off','LineWidth',1.5*lw)            if npeak == Npeaks                xlabel('td1','FontSize',fs*.6)                ylabel('\Delta\delta','FontSize',fs*.6)            end            left = left-dleft;        end        eval(['save ' num2str(expno(nexp)) '/FitDat PP FitDat'])                Ivstime = [Ivstime; FitDat.Yin(:,1)/FitDat.Y0(1)];        time = [time; max(time)+(1:length(FitDat.Yin(:,1)))'*(NMRacqus.aq+NMRacqus.d1)];        clear FitDat        delete([num2str(expno(nexp)) '/ReportFig.*'])        set(gcf, 'PaperPosition', [0 0 11 8.5],'PaperSize', [11 8.5]);         eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -dpdf'])    endendreturn%%figure(2), clfset(axes,'FontSize',fs)plot(time/60/60, Ivstime,'-b','LineWidth',lw)xlabel('time / hours')ylabel('I / I_0')set(gca,'TickDir','out','TickLength',.01*[1 1],'Box','off','LineWidth',1.5*lw)eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])