clear allwd = cd;%DataDir = '/opt/topspin2/data/DT/nmr';DataDir = '/Users/daniel/NMRdata/AVII500/DT';ExpNam = 'uFA_RARE'; %expno = 19;expno = 102; %Pixel.x = [67; 67; 70; 93]; Pixel.y = [20; 37; 76; 86];%expno = 112; Pixel.x = [67; 67; 74; 67]; Pixel.y = [20; 40; 54; 99];%expno = 109; Pixel.x = [67; 67; 70; 93]; Pixel.y = [20; 37; 76; 86];cd([DataDir '/' ExpNam])eval(['load ' num2str(expno) '/NMRacqus'])eval(['load ' num2str(expno) '/Images'])Images.Dxyz.r = Images.lambda1;Images.Dxyz.x = Images.Dxx./Images.Dxyz.r;Images.Dxyz.y = Images.Dyy./Images.Dxyz.r;Images.Dxyz.z = Images.Dzz./Images.Dxyz.r;ADCmax = max(reshape(Images.ADC,numel(Images.ADC),1));Dmax = max([max(reshape(Images.Dxx,numel(Images.ADC),1)) max(reshape(Images.Dyy,numel(Images.ADC),1)) max(reshape(Images.Dzz,numel(Images.ADC),1))]);Images.DeltaK = (Images.mu2_aniso-Images.mu2_iso)./Images.mD_gamma.^2;Images.K_aniso = Images.mu2_aniso./Images.mD_gamma.^2;Images.DeltaK_FA = 1./(5/2*(1./(Images.FA/sqrt(3/2)).^2 - 1));Images.OD = (Images.uFA - Images.FA)./Images.uFA;%Images.OP = sqrt(Images.DeltaK_FA./Images.DeltaK);Images.OP = sqrt(Images.DeltaK_FA./Images.DeltaK);%Images.OD = (Images.uFA - Images.FA);% figure(1), clf, imagesc(Images.mu2_iso')% set(gca,'YDir','normal'), axis square% hold on% plot(47,91,'kx')% return%uFA = sqrt(3/2)*sqrt(1/(1+2/5*mD_gamma^2/(mu2_aniso-mu2_iso)));%figure(1), clf, plot(Images.K_aniso,Images.K,'.'), return%figure(1), clf, plot(Images.FA,Images.DeltaK,'.'), returnCmax = 1;ADCmax = 2e-9;%Dmax = 2e-9;maskbin = [Images.S0 > .15*max(max(Images.S0)) & Images.FA>0.2];maskbin = [Images.S0 > .15*max(max(Images.S0)) & Images.uFA>0.4];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.uFA>0.7...%     & Images.FA>0.5 & Images.K<.03];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.uFA>0.65...%     & Images.FA<0.1 & Images.K<.02];maskbin = [Images.S0 > .05*max(max(Images.S0))];% maskbin = [Images.S0 > .1*max(max(Images.S0)) & Images.K>.15 ...%     & Images.K_aniso>.45 & Images.DeltaK>.2];%maskbin = [Images.S0 > .14*max(max(Images.S0)) & Images.DeltaK>0.15];%maskbin = [Images.S0 > .05*max(max(Images.S0)) & Images.mD_gamma < 1e-9];%maskbin = ones(size(Images.S0));mask = find(maskbin);[mask_x,mask_y] = find(maskbin);invmask = find(maskbin==0);%%height = .7;width = height*8.5/11;dleft = width+.05;dbottom = .3;hwidth = .7*widthhheight = height-dbottom;fs = 16*11/3.33; lw = 2*11/3.33; tl = .04;Xshift = -3;left = 0;bottom = 1-height;figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.S0_gamma(:,:));%Iplot = squeeze(Images.ADC(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 max(max(Images.S0_gamma))];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.S0_gamma,numel(Images.FA),1)/max(clim);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistS0 -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.mD_gamma(:,:));%Iplot = squeeze(Images.ADC(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 ADCmax];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = 1/1e-9*reshape(Images.mD_gamma,numel(Images.FA),1);%histdat = 1/1e-9*reshape(Images.ADC,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 2*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistMD -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.FA(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.FA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistFA -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.CP(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.CP,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistCP -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.CL(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.CL,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistCL -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.K_aniso(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.K_aniso,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistK_aniso -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.K(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.K,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistK_iso -deps'])figure(3), clfcolormap(gray(256))axes('position',[left bottom width height])Iplot = squeeze(Images.DeltaK(:,:));Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);clim = [0 1];imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.DeltaK,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistDeltaK -deps'])%%maskbin = [Images.S0 > .05*max(max(Images.S0)) & Images.DeltaK>0.15 & ...    Images.mD_gamma<1e-9];mask = find(maskbin);invmask = find(maskbin==0);figure(3), clfaxes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.FA(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = (Iplot.*Images.Dxyz.x)';Iplot2(:,:,2) = (Iplot.*Images.Dxyz.y)';Iplot2(:,:,3) = (Iplot.*Images.Dxyz.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;Iplot2 = circshift(Iplot2,[0 Xshift]);imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.FA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistFAcolor -depsc'])figure(3), clfaxes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.uFA(:,:))/max(clim);Iplot(invmask) = 0;Iplot2 = zeros([fliplr(size(Images.FA)) 3]);Iplot2(:,:,1) = (Iplot.*Images.Dxyz.x)';Iplot2(:,:,2) = (Iplot.*Images.Dxyz.y)';Iplot2(:,:,3) = (Iplot.*Images.Dxyz.z)';Iplot2(find(Iplot2>1)) = 1;Iplot2(find(Iplot2<0)) = 0;Iplot2 = circshift(Iplot2,[0 Xshift]);imagesc(r.i*1e3,r.j*1e3,Iplot2,clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.uFA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistuFAcolor -depsc'])figure(3), clfaxes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.FA(:,:))/max(clim);Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.FA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistFAbw -deps'])figure(3), clfaxes('position',[left bottom width height])clim = [0 Cmax];Iplot = squeeze(Images.uFA(:,:))/max(clim);Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);imagesc(r.i*1e3,r.j*1e3,Iplot',clim)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendhistdat = reshape(Images.uFA,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistuFAbw -deps'])figure(3), clfaxh_OD = axes('position',[left bottom width height]);clim = [0 Cmax];Iplot = squeeze(Images.OP(:,:))/max(clim);Iplot(invmask) = 0;Iplot = circshift(Iplot,Xshift);imagesc(r.i*1e3,r.j*1e3,Iplot',clim)cmap = colormap(jet(256));cmap(1,:) = 0;colormap(axh_OD,cmap)set(gca,'YDir','normal')axis equal, axis tight, axis offhold onif exist('Pixel')    for npix = 1:length(Pixel.x)        plot(r.i(Pixel.x(npix))*1e3,r.j(Pixel.y(npix))*1e3,'rx','LineWidth',lw)    endendcbarheight = 0.05;axh_cbar = axes('position',[1-hwidth+.015 bottom+dbottom+hheight-cbarheight ...    hwidth cbarheight]);imagesc([0 1], linspace(0,1,256)',[linspace(0,1,256); linspace(0,1,256)])set(gca,'XLim',[-.2 1.2])axis offhistdat = reshape(Images.OP,numel(Images.FA),1);histdat = histdat(mask);axes('position',[1-hwidth+.015 bottom+dbottom hwidth hheight-cbarheight])hist(histdat,100);axis tightylim = get(gca,'YLim');ylim = ylim(2)*[0 1.1];xlim = 1*[-.2 1.2];set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',ylim,'YTick',[],'YAxisLocation','right')eval(['print ' num2str(expno) '/ImagHistOP -depsc'])%%histdat1 = reshape(Images.FA,numel(Images.FA),1);histdat1 = histdat1(mask);histdat2 = reshape(Images.uFA,numel(Images.FA),1);histdat2 = histdat2(mask);figure(3), clfaxes('position',[1-width 1-height width height])plot(histdat1,histdat2,'b.','MarkerSize',lw)hold onplot([0 1],[0 1],'k-','LineWidth',lw)plot([0 1],1/sqrt(2)*[1 1],'k--','LineWidth',lw)set(gca,'Box','off','TickDir','out','TickLength',tl*[1 1],...    'FontSize',fs,'LineWidth',lw,...    'XLim',xlim,'YLim',xlim)eval(['print ' num2str(expno) '/ScatterFAuFA -depsc'])%%cd(wd)