clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT/';DataDir = '/opt/topspin2/data/DT/nmr';cd(DataDir)ExpNam = {'isoanisocorr_qMASopt'}; expno = 39;basl = [.03 .2 .8 .97]; lb = 20; si = 4*1024;%ll = 1251; ul = 1317;AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .25;td1start = 2;signal = 'area';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_pgseisoaniso','DT_isoanisoqMASopt'})) == 1        Spec2Dtd1        if AutoPhaseAll            AutoPhasetd1        end        PeakPick                %%        figure(1), clf, plot(1:NMRacqu2s.td,PP.Apeak(:,2),'o')%%                gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        end        fid = fopen([num2str(expno(nexp)) '/rx.txt']);        ramp.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry.txt']);        ramp.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz.txt']);        ramp.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/riso.txt']);        ramp.iso = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rx1.txt']);        ramp1.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry1.txt']);        ramp1.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz1.txt']);        ramp1.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/riso1.txt']);        ramp1.iso = fscanf(fid,'%f');        fclose(fid);                                G.x = ramp.x*Gmax.*NMRacqus.cnst1/100;        G.y = 1.00*ramp.y*Gmax.*NMRacqus.cnst2/100;        G.z = 1.0*ramp.z*Gmax.*NMRacqus.cnst3/100;        G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);        G.iso = .999*ramp.iso*Gmax.*NMRacqus.cnst1/100;        Gnorm.x = G.x./G.r; Gnorm.x(G.r==0) = 0;        Gnorm.y = G.y./G.r; Gnorm.y(G.r==0) = 0;        Gnorm.z = G.z./G.r; Gnorm.z(G.r==0) = 0;        G1.x = ramp1.x*Gmax.*NMRacqus.cnst1/100;        G1.y = ramp1.y*Gmax.*NMRacqus.cnst2/100;        G1.z = 1.0*ramp1.z*Gmax.*NMRacqus.cnst3/100;        G1.r = sqrt(G1.x.^2 + G1.y.^2 + G1.z.^2);        G1.iso = .999*ramp1.iso*Gmax.*NMRacqus.cnst1/100;        Gnorm1.x = G1.x./G1.r; Gnorm1.x(G1.r==0) = 0;        Gnorm1.y = G1.y./G1.r; Gnorm1.y(G1.r==0) = 0;        Gnorm1.z = G1.z./G1.r; Gnorm1.z(G1.r==0) = 0;        fid = fopen([num2str(expno(nexp)) '/qMASx.txt']);        Gmod.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASy.txt']);        Gmod.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASz.txt']);        Gmod.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/qMASr.txt']);        Gmod.r = fscanf(fid,'%f');        fclose(fid);                Ndt = length(Gmod.x);        figure(1), clf, plot(1:Ndt,Gmod.x,'-r',1:Ndt,Gmod.y,'-g',1:Ndt,Gmod.z,'-b',1:Ndt,Gmod.r,'-k')                tau = NMRacqus.d3;        dt = tau/Ndt;        F.r = cumsum(Gmod.r*dt);        bred.r = sum(F.r.^2*dt);                F.x = cumsum(Gmod.x*dt);        F.y = cumsum(Gmod.y*dt);        F.z = cumsum(Gmod.z*dt);        F.iso = sqrt(F.x.^2 + F.y.^2 + F.z.^2);        bred.iso = sum(F.iso.^2*dt);        b = 2*bred.iso*gamma^2*(G.r + G.iso).^2;        b1 = 2*bred.iso*gamma^2*(G1.r + G1.iso).^2;        btot = b+b1;        figure(1), clf        plot(1:td1,btot)        PP.X = b;                        index = 0*128 + find(G1.iso == min(G1.iso));        index1 = find(all([G.x == min(G.x), G.y == min(G.y), G.z == min(G.z)],2));                Idat2D = PP.Ipeak(:,2);        %Idat2D = PP.Ipeak(:,2) + .5*PP.Ipeak(:,1);        Idat2D = PP.Ipeak(:,1);        Idat_DT = Idat2D(index,:);        b_DT = b(index);        Idat_iso = Idat2D(index1,:);        b_iso = b1(index1);                Ndir2 = 256;        NG = NMRacqu2s.td/Ndir2;                Xarray = reshape(btot,Ndir2,NG)';        Yarray = reshape(Idat2D,Ndir2,NG)'                figure(1), clf        h = semilogy(Xarray,Yarray,'-o');        %set(h,{'Marker'},{'o','o','o','o','s','s','s','s','v','v','v','v','x','x','x','x'}')        %set(h,{'Color'},{'k','r','g','b','k','r','g','b','k','r','g','b','k','r','g','b'}')        axis tight        Xdat = btot;        Dnocalib = zeros(Ndir2,1);                PlotInterm = 0;            for ndir = 1:Ndir2            fitpoints = ndir - Ndir2 + (Ndir2:Ndir2:NMRacqu2s.td);            fitpoints = fitpoints(2:length(fitpoints));            ExpFit             Dnocalib(ndir) = FitDat.R(1);        end        %%        figure(2), clf        plot(1:Ndir2,Dnocalib,'o')                eval(['save ' num2str(expno(nexp)) '/Dnocalib Dnocalib'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])        %eval(['save ' num2str(expno(nexp)) '/FitDat PP'])    endend