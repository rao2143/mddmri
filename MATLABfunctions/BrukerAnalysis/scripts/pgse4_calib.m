clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT/';DataDir = '/opt/topspin2/data/DT/nmr';cd(DataDir)ExpNam = {'pgse4_test'}; expno = 16;basl = [.03 .2 .8 .97]; lb = 20; si = 4*1024;%ll = 1251; ul = 1317;AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .5;td1start = 2;signal = 'area';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'N';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_4pgse','DT_4pgse2'})) == 1        Spec2Dtd1        if AutoPhaseAll            AutoPhasetd1        end        PeakPick        %%        figure(2), clf, plot(1:NMRacqu2s.td,PP.Apeak(:,1),'o')        gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        end        fid = fopen([num2str(expno(nexp)) '/rx1.txt']);        ramp1.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry1.txt']);        ramp1.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz1.txt']);        ramp1.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rx2.txt']);        ramp2.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry2.txt']);        ramp2.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz2.txt']);        ramp2.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rx3.txt']);        ramp3.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry3.txt']);        ramp3.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz3.txt']);        ramp3.z = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rx4.txt']);        ramp4.x = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/ry4.txt']);        ramp4.y = fscanf(fid,'%f');        fclose(fid);        fid = fopen([num2str(expno(nexp)) '/rz4.txt']);        ramp4.z = fscanf(fid,'%f');        fclose(fid);                Gcalib.x = 1;        Gcalib.y = 1;        Gcalib.z = 1;                G1.x = Gcalib.x*ramp1.x*Gmax.*NMRacqus.cnst1/100;        G1.y = Gcalib.y*ramp1.y*Gmax.*NMRacqus.cnst2/100;        G1.z = Gcalib.z*ramp1.z*Gmax.*NMRacqus.cnst3/100;        G1.r = sqrt(G1.x.^2 + G1.y.^2 + G1.z.^2);        Gnorm1.x = G1.x./G1.r; Gnorm1.x(G1.r==0) = 0;        Gnorm1.y = G1.y./G1.r; Gnorm1.y(G1.r==0) = 0;        Gnorm1.z = G1.z./G1.r; Gnorm1.z(G1.r==0) = 0;        G2.x = Gcalib.x*ramp2.x*Gmax.*NMRacqus.cnst1/100;        G2.y = Gcalib.y*ramp2.y*Gmax.*NMRacqus.cnst2/100;        G2.z = Gcalib.z*ramp2.z*Gmax.*NMRacqus.cnst3/100;        G2.r = sqrt(G2.x.^2 + G2.y.^2 + G2.z.^2);        Gnorm2.x = G2.x./G2.r; Gnorm2.x(G2.r==0) = 0;        Gnorm2.y = G2.y./G2.r; Gnorm2.y(G2.r==0) = 0;        Gnorm2.z = G2.z./G2.r; Gnorm2.z(G2.r==0) = 0;        G3.x = Gcalib.x*ramp3.x*Gmax.*NMRacqus.cnst1/100;        G3.y = Gcalib.y*ramp3.y*Gmax.*NMRacqus.cnst2/100;        G3.z = Gcalib.z*ramp3.z*Gmax.*NMRacqus.cnst3/100;        G3.r = sqrt(G3.x.^2 + G3.y.^2 + G3.z.^2);        Gnorm3.x = G3.x./G3.r; Gnorm3.x(G3.r==0) = 0;        Gnorm3.y = G3.y./G3.r; Gnorm3.y(G3.r==0) = 0;        Gnorm3.z = G3.z./G3.r; Gnorm3.z(G3.r==0) = 0;        G4.x = Gcalib.x*ramp4.x*Gmax.*NMRacqus.cnst1/100;        G4.y = Gcalib.y*ramp4.y*Gmax.*NMRacqus.cnst2/100;        G4.z = Gcalib.z*ramp4.z*Gmax.*NMRacqus.cnst3/100;        G4.r = sqrt(G4.x.^2 + G4.y.^2 + G4.z.^2);        Gnorm4.x = G4.x./G4.r; Gnorm4.x(G4.r==0) = 0;        Gnorm4.y = G4.y./G4.r; Gnorm4.y(G4.r==0) = 0;        Gnorm4.z = G4.z./G4.r; Gnorm4.z(G4.r==0) = 0;                        delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;        Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p2/1e6;        tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;        b1 = (gamma*G1.r*delta).^2*tdiff;        b2 = (gamma*G2.r*delta).^2*tdiff;        b3 = (gamma*G3.r*delta).^2*tdiff;        b4 = (gamma*G4.r*delta).^2*tdiff;        btot = b1+b2+b3+b4;                figure(1), clf        subplot(2,1,1)        plot(1:td1,b1,1:td1,b2,1:td1,b3,1:td1,b4,1:td1,btot)        subplot(2,1,2)        semilogy(btot,PP.Ipeak,'o')        set(gca,'YLim',max(max(PP.Ipeak))*[1e-2 1])        return%%        PP.X = btot;                                Idat2D = PP.Ipeak(:,2);        %Idat2D = PP.Ipeak(:,2) + .5*PP.Ipeak(:,1);        Idat2D = PP.Ipeak(:,1);        Idat_DT = Idat2D(index,:);        b_DT = b(index);        Idat_iso = Idat2D(index1,:);        b_iso = b1(index1);                Ndir2 = 256;        NG = NMRacqu2s.td/Ndir2;                Xarray = reshape(btot,Ndir2,NG)';        Yarray = reshape(Idat2D,Ndir2,NG)'                figure(1), clf        h = semilogy(Xarray,Yarray,'-o');        %set(h,{'Marker'},{'o','o','o','o','s','s','s','s','v','v','v','v','x','x','x','x'}')        %set(h,{'Color'},{'k','r','g','b','k','r','g','b','k','r','g','b','k','r','g','b'}')        axis tight        Xdat = btot;        Dnocalib = zeros(Ndir2,1);                PlotInterm = 0;            for ndir = 1:Ndir2            fitpoints = ndir - Ndir2 + (Ndir2:Ndir2:NMRacqu2s.td);            fitpoints = fitpoints(2:length(fitpoints));            ExpFit             Dnocalib(ndir) = FitDat.R(1);        end        %%        figure(2), clf        plot(1:Ndir2,Dnocalib,'o')                eval(['save ' num2str(expno(nexp)) '/Dnocalib Dnocalib'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])        %eval(['save ' num2str(expno(nexp)) '/FitDat PP'])    endend