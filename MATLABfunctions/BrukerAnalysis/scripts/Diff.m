clear allwd = fileparts(mfilename('fullpath'));AutoPhase = 1;AutoPhaseAll = 0;CheckBasline = 0;FindPeaks = 1;CheckPeaks = 0;PlotInterm = 0;thresh = .00005;td1start = 1; %td1end = 21;Imin = 1e-4;BiexpFitFlag = 0;signal = 'area'; %signal = 'intensity';%DataDir = '/Users/daniel/Dropbox';%DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/Users/daniel/NMRdata/AVII200/';%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/opt/topspin/data/DT/nmr';%DataDir = '/Users/daniel/Dropbox/NMRdata/AVII200/Dat';%DataDir = '/Users/daniel/Dropbox/NMRdata/AVII500';%DataDir = '/Users/daniel/Dropbox/NMRdata/AVII200';% DataDir = '/opt/nmrdata/daniel';%DataDir = '/Users/daniel/Dropbox/NMRdata/AV4_500/Simon';DataDir = '/Users/daniel/Dropbox/NMRdata/AV4_500/daniel';cd(DataDir)ExpNam = {'20230419_mousebrain'}; expno = [25:26]; expno = 26; thresh = .01;td1start = 2;basl = [0.01 .05   .95 .99];lb = 10; si = 2*1024; ppmshift = 0;% ExpNam = {'20230420_leachate'}; expno = [5]; thresh = .00005;% td1start = 2;% basl = [0.01 .25   .7 .99];% lb = 5; si = 32*1024; ppmshift = 0;% ExpNam = {'qdor_hex10mm_20210826'}; expno = [77];% td1start = 1;% basl = [0.01 .1   .9 .99];% lb = 5; si = 4*1024; ppmshift = 0;% ExpNam = {'trteaxde_composite7'}; expno = 5;%ExpNam = {'trteaxde_yeast'}; expno = 3;%ExpNam = {'isoDW_test'}; expno = 72;%ExpNam = {'isoDW'}; expno = 10;%ExpNam = {'isoaniso_test'}; %expno = 24;%ExpNam = {'BileSaltCylinder'}; %expno = 3;%basl = [.02 .1 .9 .98]; lb = 20; si = 4*1024;%ll = 1959; ul = 2307;% ExpNam = {'Yeast20120919'}; expno = 30+(7:-1:2);% basl = [.05 .2 .8 .95]; lb = 10; si = 8*1024;% ExpNam = {'qMASopt'}; expno = 40;% basl = [.02 .35 .65 .98]; lb = 10; si = 16*1024;%ExpNam = {'Spindiff'}; expno = 62;%basl = [.05 .2 .8 .95]; lb = 10; si = 1*1024;%ExpNam = {'Starch_DRcorr'}; expno = 151:170; BiexpFitFlag = 1;%basl = [.05 .3 .7 .95];%ExpNam = {'qVAS_Starch'}; expno = 108; BiexpFitFlag = 0;%ll = [420 503]; ul = [440 523];%basl = [.05 .3 .7 .95];%ExpNam = {'DiffCR_setup'}; %expno = 38;%basl = [.05 .3 .7 .95]; lb = 200; si = 2*1024;%ExpNam = {'AOTisooctane'}; expno = 38;%basl = [.05 .3 .7 .95]; lb = 10; si = 2*1024;% ExpNam = {'YeastMSG'}; expno = 15:23;% peakmid = [732%     885%     929%     1349%         1500%         1560%         1942%         2149%         2216%         2715%         2770%         2929];%     ul = peakmid + 2; ll = peakmid - 2;% ExpNam = {'AOToct2'}; expno = 24; expno = 25;% basl = [.03 .2 .8 .97]; lb = 5; si = 4*1024;% ll = [2698 2770 2825]; ul = [2708 2780 2835];%ExpNam = {'EOS_2017Jan'}; expno = 19;%basl = [.02 .5 .7 .98]; lb = 100; si = 512;%ll = [2698 2770 2825]; ul = [2708 2780 2835];% ExpNam = {'CK_170306'}; expno = 26; expno = 76;% lb = 1; %si = 8*1024;% ExpNam = {'MN_waveforms'};% lb = 10; %si = 8*1024;% ExpNam = {'MIC5_kasia'}; expno = 47;% basl = [.02 .15 .6 .75 .83 .98]; lb = 5; si = 4*1024;% ll = [700 1271 1774 3140 3259]'; ul = [800 1420 1827 3188 3311]';% % ExpNam = {'MIC5_kasia'}; expno = 57;% basl = [.02 .1 .63 .75 .87 .95]; lb = 5; si = 4*1024;% ll = [751 1354 1862 3213 3335]'; ul = [881 1436 1918 3258 3371]';% ExpNam = {'MIC5_kasia'}; expno = 139;% basl = [.02 .19 .6 .71 .8 .98]; lb = 5; si = 4*1024;% ll = [844 1342 2952 3051]'; ul = [979 1478 2998 3094]';% % ExpNam = {'MIC5_kasia'}; expno = 187; %expno = 198;% basl = [.02 .19 .6 .71 .8 .98]; lb = 5; si = 4*1024;% ll = [870 ]'; ul = [980 ]';cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    ConvertAcqus = 'Y';    ConvertProcs = 'Y';    MakeTextfile = 'N';    if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0        ConvertAcqus = 'Y';    end    res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])    if any(strcmp(NMRacqus.pulprog,{'DT_pgste','DT_pgse','DT_pgsefexsy','DT_tepgse'...            'DT_dfpgsefexsy','DT_dftmpgse','DT_dfpgste','DT_fexsydpgste','DT_fexsy3',...            'DT_dftepgse','DT_mdfpgse','DT_qMASdt','DT_bppg4project','DT_pgstetd',...            'DT_bppgste','DT_bppgsteledT1'})) == 1                Spec2Dtd1        PeakPick        gamma = 26.75e7;        if strcmp(NMRacqus.nuc1,'2H') == 1            gamma = 4.1065e7;        elseif strcmp(NMRacqus.nuc1,'23Na') == 1            gamma = 7.0761e7;        end        Gmax = 3;        if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1            Gmax = 0.5;        elseif any(strcmp(NMRacqus.probhd,{'5 mm Diff25 1H Z-GRD H7979/10','5 mm Diff25 1H Z-GRD H7979/12'})) == 1            Gmax = 9.6;            NMRacqus.cnst1 = 0;            NMRacqus.cnst2 = 0;                   end        if any(strcmp(NMRacqus.pulprog,{'DT_bppgsteledT1'})) == 1            difframp.x = mdm_bruker_grad_read([num2str(expno(nexp)) '/DT_gcx']);            difframp.y = mdm_bruker_grad_read([num2str(expno(nexp)) '/DT_gcy']);            difframp.z = mdm_bruker_grad_read([num2str(expno(nexp)) '/DT_gcz']);        else            difframp.x = mdm_bruker_grad_read([num2str(expno(nexp)) '/diff_ramp']);            difframp.y = difframp.x;            difframp.z = difframp.x;        end                    G.x = difframp.x*Gmax.*NMRacqus.cnst1/100;        G.y = difframp.y*Gmax.*NMRacqus.cnst2/100;        G.z = difframp.z*Gmax.*NMRacqus.cnst3/100;        G.r = sqrt(G.x.^2 + G.y.^2 + G.z.^2);        Gnorm.x = G.x./G.r;        Gnorm.y = G.y./G.r;        Gnorm.z = G.z./G.r;                if any(strcmp(NMRacqus.pulprog,{'DT_pgse','DT_fexsy3','DT_pgsefexsy',...                'DT_dftepgse','DT_mdfpgse','DT_dfpgsefexsy','DT_dftmpgse','DT_tepgse'})) == 1            delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;            Delta = delta+epsilon+2*NMRacqus.d4+NMRacqus.p2/1e6;            tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        elseif any(strcmp(NMRacqus.pulprog,{'DT_bppgste','DT_bppgsteledT1'})) == 1            epsilon = NMRacqus.d2;            delta = 2*(NMRacqus.d2 + NMRacqus.d3);            Delta = 2*NMRacqus.d2 + 2*NMRacqus.d3 + 2*NMRacqus.d4 + 2*NMRacqus.d6...                + NMRacqus.d5 + 2*1e-6*NMRacqus.p1 + 1e-6*NMRacqus.p2;                        if NMRacqus.l11                Delta = Delta + NMRacqus.d46 + 2*NMRacqus.d42 + NMRacqus.d43;            end            tau = 2*NMRacqus.d4 + 1e-6*NMRacqus.p2;            tdiff = Delta-delta/3-tau/2-epsilon/2-epsilon^2/6/delta+epsilon^3/15/delta^2;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        elseif any(strcmp(NMRacqus.pulprog,{'DT_bppg4project'})) == 1            delta = 6*(NMRacqus.d3+NMRacqus.d2); epsilon = NMRacqus.d2;            Delta = 6*(NMRacqus.d3+2*NMRacqus.d2)+6*NMRacqus.d4+5*NMRacqus.d6...                +3*NMRacqus.p2/1e6+2*NMRacqus.p1/1e6;            %tdiff just approximate, but good enough for now            tdiff = Delta-delta/3;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        elseif any(strcmp(NMRacqus.pulprog,{'DT_pgste','DT_dfpgste','DT_fexsydpgste'})) == 1            delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;            Delta = delta+epsilon+2*NMRacqus.d4+2*NMRacqus.p1/1e6+NMRacqus.d5 + 3*NMRacqus.d22;            if NMRacqus.l11 == 1                Delta = Delta + NMRacqus.d13+2*NMRacqus.d12 + 2*NMRacqus.d22;            end            tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        elseif any(strcmp(NMRacqus.pulprog,{'DT_pgstetd'})) == 1            delta = NMRacqus.d3+NMRacqus.d2; epsilon = NMRacqus.d2;            Delta = delta+epsilon+2*NMRacqus.d4+2*NMRacqus.p1/1e6+NMRacqus.vd(1) + 3*NMRacqus.d22;            Delta_v = delta+epsilon+2*NMRacqus.d4+2*NMRacqus.p1/1e6+NMRacqus.vd + 3*NMRacqus.d22;            if NMRacqus.l11 == 1                Delta = Delta + NMRacqus.d13+2*NMRacqus.d12 + 2*NMRacqus.d22;                Delta_v = Delta_v + NMRacqus.d13+2*NMRacqus.d12 + 2*NMRacqus.d22;            end            tdiff = Delta-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;            tdiff_v = Delta_v-delta/3+epsilon^3/30/delta^2-epsilon^2/6/delta;            q = gamma*G.r*delta/2/pi;            b = (2*pi*q).^2*tdiff;        end        PP.X = b;        eval(['save ' num2str(expno(nexp)) '/PeakDat PP'])        Xdat = b;        if npeak < Npeaks            set(gca,'XTick',[],'YTick',[])        end        if exist('td1end') == 0            td1end = NMRacqu2s.td;        end        fitpoints = td1start:td1end;        if any(strcmp(NMRacqus.pulprog,{'DT_fexsy3','DT_pgsefexsy','DT_dfpgsefexsy','DT_mdfpgse',...                'DT_dftepgse','DT_dftmpgse','DT_tepgse','DT_pgstetd'})) == 1            fitpoints = td1start:length(Xdat);        end                if exist('BiexpFitFlag') == 0            BiexpFitFlag = 0;        end        if BiexpFitFlag            BiexpFit        else            ExpFit        end                if strcmp(NMRacqus.pulprog,'DT_pgstetd')            Xdat = repmat(b,[NMRacqus.l2 1]);            FitDatCell{1} = FitDat;            for ntd = 2:NMRacqus.l2                fitpoints = (1:NMRacqus.l1) + NMRacqus.l1*(ntd-1);                ExpFit                FitDatCell{ntd} = FitDat;            end        end                    %%        fs = 12;        lw = 1;        figure(1), clf        axes('position',[-.01 .15 1.02 .35],'FontSize',fs*.8)        plot(PP.ppm,PP.Ispec,'k','LineWidth',lw)        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*lw,'Box','off','TickDir','out','Ycolor',[1 1 1])        axis('tight')        ylim = get(gca,'YLim');        ylim = .05*diff(ylim)*[-1 1] + ylim;        set(gca,'YLim',ylim)        xlabel(['\delta(' NMRacqus.nuc1 ') / ppm'],'FontSize',fs)        if Npeaks > 1            hold on            plot(PP.peakppm(td1start,:),PP.Ipeak(td1start,:),'bo','LineWidth',lw)            h1 = plot(PP.ppm,-1*ylim(1)+.05/thresh*PP.Ispec,'k','LineWidth',.5*lw);            set(h1,'Color',.75*[1 1 1])            plot(PP.peakppm(td1start,:),-1*ylim(1)+.05/thresh*PP.Ipeak(td1start,:),'bo','LineWidth',lw)        end        dleft = (1-.1)/Npeaks;        width = .9*dleft;        height = .25;        left = 1-width;        bottom = .65;        if Npeaks == 1, width = .6*1/2; end        for npeak = 1:Npeaks            axh1 = axes('position',[left bottom width height],'FontSize',fs*.8);            h2 = semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/FitDat.Y0(npeak),'bo');            hold on            h3 = semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/FitDat.Y0(npeak),'k--','LineWidth',lw);            axis('tight')            ylim = get(gca,'YLim');            %ylim = .05*abs(diff(ylim))*[-1 1] + abs(ylim); ylim(1) = 0;            ylim = ylim(2)*[Imin 1.2];            xlim = get(gca,'XLim');            xlim = .05*diff(xlim)*[-1 1] + xlim;            set(gca,'XLim',xlim,'YLim',ylim,...                'TickLength',.02*[1 1],'TickDir','out','Box','off','YMinorTick','on','LineWidth',1.5*lw)            set(gca,'YTick',[1e-3 1e-2 1e-1 1])            %set(gca,'XTick',[1e7 1e8 1e9 1e10 1e11])            if BiexpFitFlag                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                [num2str(FitDat.Pfast(npeak),3)];...                [num2str(FitDat.Rfast(npeak),3) ' m^2s^-^1'];...                [num2str(FitDat.Rslow(npeak),3) ' m^2s^-^1']...                },'FontSize',fs*.5)            else                title({[num2str(PP.peakppm(td1start,npeak),3) ' ppm'];...                [num2str(FitDat.R(npeak),3) ' m^2s^-^1']},'FontSize',fs*.5)            end            if any(strcmp(NMRacqus.pulprog,{'DT_fexsy3'})) == 1                Iplot = reshape(PP.Ipeak(:,npeak),length(PP.X),NMRacqu2s.td/length(PP.X));                if strcmp(FitDat.signal,'area')==1                            Iplot = reshape(PP.Apeak(:,npeak),length(PP.X),NMRacqu2s.td/length(PP.X));                end                semilogy(PP.X,Iplot/FitDat.Y0(npeak),'-bo')                semilogy(PP.X,Iplot(:,1)/FitDat.Y0(npeak),'ko')                semilogy(PP.X,Iplot(:,2)/FitDat.Y0(npeak),'ro')            end            if strcmp(NMRacqus.pulprog,'DT_pgstetd')                delete([h2 h3])                FitDat = FitDatCell{1};                Y0 = FitDat.Y0(npeak);                D_v = zeros(NMRacqus.l2,1);                for ntd = 1:NMRacqus.l2                    FitDat = FitDatCell{ntd};                    semilogy(FitDat.Xin(:,npeak),FitDat.Yin(:,npeak)/Y0,'bo')                    hold on                    semilogy(FitDat.Xin(:,npeak),FitDat.Yout(:,npeak)/Y0,'b-')                    D_v(ntd) = FitDat.R;                end                axh2 = axes('position',[left+.8*width bottom+.8*height .3*width .3*height],'FontSize',fs*.5);                semilogx(axh2,tdiff_v,D_v,'o')                set(gca,'Box','off','TickDir','out','TickLength',.04*[1 1],'LineWidth',1*lw)                xlim = [min(tdiff_v)/sqrt(10) max(tdiff_v)*sqrt(10)];                set(gca,'XLim',xlim,'XScale','log','XTick',[1e-3 1e-2 1e-1 1])                ylabel(axh2,'D / m^2s^-^1','FontSize',fs*.5)                xlabel(axh2,'t_d / s','FontSize',fs*.5)                %axes(axh1);                FitDat = FitDatCell;            end            xlim = [min(PP.X)/2 max(PP.X)*2];            %set(gca,'XLim',xlim,'XScale','log')            if npeak < Npeaks                set(axh1,'XTick',[],'YTick',[])            end            if npeak == Npeaks                xlabel(axh1,'b / sm^-^2','FontSize',fs)                ylabel(axh1,'I / I_0','FontSize',fs)            end            left = left-dleft;        end                       eval(['save ' num2str(expno(nexp)) '/Itd1Dat Itd1 ppm b'])                eval(['save ' num2str(expno(nexp)) '/FitDat FitDat'])        delete([num2str(expno(nexp)) '/ReportFig.*'])        aspect = 1.6;        set(gcf, 'PaperUnits','centimeters','PaperPosition', 2*8.3*[0 0 1 1/aspect],'PaperSize', 2*8.3*[1 1/aspect]);        eval(['print -dpdf -loose ' num2str(expno(nexp)) '/ReportFig'])    endend