clear allwd = cd;cd('/Users/daniel/NMRdata/AVII500/Nils_C8G2/')ExpNam = {'C8G2_RH96_3'};expno = 87;offset = [14.4];T2 = [10];ampl = 1e5*[3];ppmlimits = offset + 10/T2*[-1 1];NMC = 0;fontsize = 20;linewidth = 1;for ndir = 1:length(ExpNam)    ExpNam{ndir}    cd(ExpNam{ndir})    for nexp = 1:length(expno)        load([num2str(expno(nexp)) '/SpecDat.mat'],'Spec')        ppm = Spec.ppm;        I = Spec.I;        fitpoints = [];        for nppm = 1:2:length(ppmlimits)-1            fitpoints = [fitpoints; find([ppm>ppmlimits(nppm) & ppm<ppmlimits(nppm+1)])];        end        %figure(1), clf, plot(ppm,I,ppm(fitpoints),I(fitpoints),'.r'), axis([min(ppm) max(ppm) max(I(fitpoints))*[-.1 1.1]]),     set(gca,'XDir','reverse','YTick',[],'LineWidth',linewidth), return        Xin = ppm(fitpoints);        Yin = I(fitpoints);        phase = 0;        Pin = [T2 ampl offset]; Funam = 'fSumLorentz';        LB = [1*ones(size(T2)) 10*ones(size(ampl)) offset-.5];        UB = [100*ones(size(T2)) 1e7*ones(size(ampl)) offset+.5];        LB = [.99*T2 10*ones(size(ampl)) offset-.01];        UB = [1.01*T2 1e7*ones(size(ampl)) offset+.01];        Pout = Pin; Ynorm = mean(Yin); Xnorm = mean(Xin); Pnorm = Pin;         %Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,[],Pnorm,Xnorm,Ynorm);        Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,[],[],[],Pnorm,Xnorm,Ynorm);        Ycalc = feval(Funam,Pout,Xin,ones(size(Pin)),1,1); error = Yin - Ycalc;        Npeak = length(Pout)/3;        T2 = Pout(1:Npeak);        ampl = Pout(Npeak+1:2*Npeak);        offset = Pout(2*Npeak+1:3*Npeak);        relampl = ampl/sum(ampl);        figure(1), clf        axes('FontSize',fontsize,'LineWidth',linewidth)        plot(ppm,I,'k','LineWidth',3)        hold on        Ycalc = real(fSumLorentz(Pout,ppm,1,1,1));        plot(ppm,Ycalc,'b','LineWidth',1)        xlabel('\delta(^{13}C) / ppm','FontSize',fontsize)        set(gca,'XDir','reverse','YTick',[],'LineWidth',linewidth)        if NMC > 0            Yin1 = Yin;            noiselevel = std(error);            Poutarray = zeros(NMC,length(Pin));            for nMC = 1:10                Yin = Yin1 + 2*noiselevel*randn(size(Yin));                Pout = Pnorm.*lsqcurvefit(Funam,Pin./Pnorm,Xin/Xnorm,Yin/Ynorm,LB./Pnorm,UB./Pnorm,[],Pnorm,Xnorm,Ynorm);                Poutarray(nMC,:) = Pout;                ampl = Pout(Npeak+1:2*Npeak);                relamplarray(nMC,:) = ampl/sum(ampl);            end            FitDat.Npeak = length(Pout)/3;            FitDat.T2 = mean(Poutarray(:,1:Npeak),1);            FitDat.ampl = mean(Poutarray(:,Npeak+1:2*Npeak),1);            FitDat.offset = mean(Poutarray(:,2*Npeak+1:3*Npeak),1);            FitDat.T2std = std(Poutarray(:,1:Npeak),1);            FitDat.amplstd = std(Poutarray(:,Npeak+1:2*Npeak),1);            FitDat.offsetstd = std(Poutarray(:,2*Npeak+1:3*Npeak),1);            save FitDat FitDat            ampl = FitDat.ampl;            relampl = mean(relamplarray,1);            relamplstd = std(relamplarray,1);        end        for nppm = 1:2:length(ppmlimits)-1            ppmindex = find([ppm>ppmlimits(nppm) & ppm<ppmlimits(nppm+1)]);            Pin = [T2 ampl offset];            Icalc = fSumLorentz(Pin,ppm(ppmindex),1,1,1);            Icalc = real(Icalc);            plot(ppm(ppmindex),Icalc,'r-','LineWidth',2)        end        for npeak = 1:length(ampl)            ppmindex = find([ppm>offset(npeak)-1/T2(npeak) & ppm<offset(npeak)+1/T2(npeak)]);            Pin = [T2(npeak) ampl(npeak) offset(npeak)];            Icalc = fSumLorentz(Pin,ppm(ppmindex),1,1,1);            Icalc = real(Icalc);            TextString = [{[num2str(offset(npeak),3) 'ppm']};                {[num2str(100*relampl(npeak),2) '%']}];            if NMC > 0                TextString = [{[num2str(offset(npeak),3) 'ppm']};                    {[num2str(100*relampl(npeak),2) '\pm' num2str(100*relamplstd(npeak),1) '%']}];            end            text(offset(npeak),max(Icalc),TextString,...                'FontSize',6,'HorizontalAlignment','center','VerticalAlignment','bottom')        end        %axis([min(ppm) max(ppm) max(max(max(Ycalc)))*[-.2 1.1]]), grid        axis([min(ppmlimits) max(ppmlimits) max(max(max(Ycalc)))*[-.2 1.1]]), grid        plot(Xin,error/max(abs(error))*max(Ycalc)*.1 - max(Ycalc)*.1,'k'), grid        hold off        set(gca,'XDir','reverse','YTick',[],'LineWidth',1.5*linewidth,'Box','off','TickDir','out','Ycolor',[1 1 1])        Inorm = ampl(length(ampl));        ppmnorm = offset(length(ampl));    end    cd ..endcd(wd)