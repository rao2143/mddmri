clear allwd = cd;%DataDir = '/Users/daniel/NMRdata/AVII500/DT';%DataDir = '/Users/daniel/NMRdata/AVII500/';%DataDir = '/opt/topspin2/data/DT/nmr';%DataDir = '/Users/daniel/Dropbox';% DataDir = '/opt/data/DT/nmr/';%DataDir = '/Users/daniel/Dropbox/NMRdata/AV4_500/daniel';DataDir = '/opt/nmrdata/daniel';cd(DataDir)ExpNam = {'MIC5_10mm_setup'}; expno = [173 223 233 243 253 263 273 293 304 313 316 324 334 344 354 364 374 384];expno = 384;ExpNam = {'mousebrain_20220530'}; expno = [2 21]; expno = 21;%ExpNam = {'mousebrain_20220523'}; expno = [2]; expno = 2;%ExpNam = {'mrfood_trteaxde_dor_20220218'}; expno = [2 12 19 22 44 54]; expno = 54;%ExpNam = {'composite10mm_trteaxde_dor_20220216'}; expno = [2]; expno = 2;%ExpNam = {'popc_trteaxde_dor_20220214'}; expno = [5 16 26 30 36]; expno = 36;%ExpNam = {'mousetumor_trteaxde_dor_20220106'}; expno = [2]; expno = 2;%ExpNam = {'mousetumor_trteaxde_dor_20211207'}; expno = [2]; expno = 2;%ExpNam = {'mousetumor_trteaxde_dor_20211110'}; expno = [2]; expno = 2;%ExpNam = {'composite10mm_temp_20210928'}; expno = [3:10:103]; expno = 103;%ExpNam = {'MIC5_setup_Maxime'}; expno = [2]; expno = 2;%ExpNam = {'composite10mm_temp_20210928'}; expno = [3:10:103]; expno = 103;%ExpNam = {'MIC5_10mm_eddytest_20210928'}; expno = [2]; expno = 2;%ExpNam = {'composite10mm_trteaxde_dor_20210927'}; expno = [2]; expno = 2;%ExpNam = {'hex10mm_tjump_20210923'}; expno = [2 4 6 8 10 12 14 20 24 30]; expno = 30;%ExpNam = {'trteaxde_pptest_20210920'}; expno = [4 27 28]; expno = 28;%ExpNam = {'trteaxde_hex10mm_20210907'}; expno = 2;%ExpNam = {'trteaxde_hex10mm_20210906'}; expno = 2;%ExpNam = {'qdor_hex10mm_20210826'}; expno = 79;%ExpNam = {'qdor_hex10mm_20210823'}; expno = 2;%ExpNam = {'qdor_hex10mm_20210816'}; expno = 15;%ExpNam = {'qdor_composite_MgNO32_lam_H20'}; %expno = 154;%ExpNam = {'trteaxde_composite7'}; expno = 42;%ExpNam = {'trteaxde_yeast'};%ExpNam = {'qdor_yeast2'};%ExpNam = {'trteaxde_composite6'};%ExpNam = {'lamellar_278Kstability'};%ExpNam = {'trteaxde_composite4'};%ExpNam = {'trteaxde_composite3'};%ExpNam = {'trteaxde_composite2'};%ExpNam = {'trteaxde_composite'};%ExpNam = {'Norah'};% ExpNam = {'DTI_HHnerve'};% ExpNam = {'HHnerve4'};% ExpNam = {'HHnerve3'};% ExpNam = {'HHnerve2'};%ExpNam = {'qMASdtirare2d_test'; 'qMASopt'; 'pgse4_test'; 'isoanisocorr_qMASopt'; 'RARE3Dtest'};%ExpNam = {'DiffVACSY'};%ExpNam = {'qVAS_Starch'};%ExpNam = {'AOToct'}; expno = 114;%ExpNam = {'AOToct_temp4'}; expno = [4 14 24 34]; expno = 34;%ExpNam = {'AOToct_temp5'};%ExpNam = {'AOToct_temp6'}; expno = 14:10:264;%ExpNam = {'imse3d_test'}; expno = 22;%ExpNam = {'AOToct3'};%ExpNam = {'AOToct4'};%ExpNam = {'Tissue_qVAS'};%ExpNam = {'AOToct5'};%ExpNam = {'C14E5'};%ExpNam = {'MIC5_2H_setup'}; expno = [13 19]; expno = 19;%ExpNam = {'AOToct8'};%ExpNam = {'AOToct9'};%ExpNam = {'C14E5_6'};%ExpNam = {'C14E5_7'};% ExpNam = {'MIC5test'}; expno = 6;%GetExpnamslb = 150e-6;si = 2*128; six = 2*64; siy = six;for ndir = 1:length(ExpNam)       ExpNam{ndir}    cd(ExpNam{ndir})    if exist('expno') == 0        GetExpnos    end    fontsize = 15;    for nexp = 1:length(expno)                ConvertAcqus = 'N';    ConvertProcs = 'N';    MakeTextfile = 'N';        if exist([num2str(expno(nexp)) '/NMRacqus.mat']) == 0            ConvertAcqus = 'Y';        end        res = fExpnoInfo2(ConvertAcqus,MakeTextfile,ConvertProcs,expno(nexp));        eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if all([any(strcmp(NMRacqus.pulprog,{'DT_imse3d','DT_imge3d'})) == 1;...                exist([num2str(expno(nexp)) '/ser'])])            eval(['load ' num2str(expno(nexp)) '/NMRacqu2s'])            td = 256*ceil(NMRacqus.td/256);            tdim.z = td/2;            tdim.y = NMRacqus.l2;            tdim.x = NMRacqus.l3;            Slength = tdim.z*tdim.y*tdim.x;            dw = 1/NMRacqus.sw_h/2;            t = 2*dw*(0:(tdim.z-1))';            t = t-t(tdim.z/2+1);            gamma = 26.75e7;            if strcmp(NMRacqus.nuc1,'2H') == 1                gamma = 4.1065e7;            elseif strcmp(NMRacqus.nuc1,'23Na') == 1                gamma = 7.0761e7;            end            Gmax = 3;            if any(strcmp(NMRacqus.probhd,{'5 mm BBO BB-1H/D XYZ-GRD Z107255/0001',...                    '5 mm TXI 1H/D-13C/15N XYZ-GRD Z8588/0006'})) == 1                Gmax = 0.5;            end            g.z = NMRacqus.cnst13*Gmax/100;            k.z = gamma*g.z*t/2/pi;            g.x = linspace(-1,1,tdim.x+1)'*Gmax*NMRacqus.cnst21/100; g.x = g.x(1:tdim.x);            g.y = linspace(-1,1,tdim.y+1)'*Gmax*NMRacqus.cnst22/100; g.y = g.y(1:tdim.y);            t_phasenc = NMRacqus.d33 + NMRacqus.d32;            k.x = gamma*g.x'*t_phasenc/2/pi;            k.y = gamma*g.y'*t_phasenc/2/pi;            if exist('six') == 0                nudim.x = NMRacqus.l3;            else                nudim.x = six;            end            if exist('siy') == 0                nudim.y = NMRacqus.l2;            else                nudim.y = siy;            end            if exist('si') == 0                nudim.z = NMRacqus.td/2;            else                nudim.z = si;            end                        r.x = .5/(k.x(2)-k.x(1))*linspace(-1,1,nudim.x+1)'; r.x = r.x(1:nudim.x);            r.y = .5/(k.y(2)-k.y(1))*linspace(-1,1,nudim.y+1)'; r.y = r.y(1:nudim.y);            r.z = .5/(k.z(2)-k.z(1))*linspace(-1,1,nudim.z+1)'; r.z = r.z(1:nudim.z);                        resolution.x = abs(r.x(2)-r.x(1));            resolution.y = abs(r.y(2)-r.y(1));            resolution.z = abs(r.z(2)-r.z(1));            lbfunz = exp(-(lb*pi*k.z).^2);            lbfunx = exp(-(lb*pi*k.x).^2);            %figure(1), clf, plot(k.z,lbfunz,'o',k.x,lbfunx,'s'), return            fid = fopen([num2str(expno(nexp)) '/ser'],'r','ieee-le');            S = fread(fid,[2,Slength],'long');            S = S(1,:) + 1i*S(2,:);            fclose(fid);            %figure(1), clf, plot(1:Slength,real(S),1:Slength,imag(S)), return            S = reshape(S,tdim.z,tdim.y,tdim.x);            S = S - mean(mean(mean(S([1:round(.1*tdim.z) round(.9*tdim.z):tdim.z],:,:))));            Stemp = S(:,tdim.y/2+1,tdim.x/2+1);            %figure(1), clf, plot(1:tdim.z,real(Stemp)), return            grpdlycount = (1:tdim.z)'/tdim.z - floor(tdim.z/2);            zeroshiftfun = exp(-1i*((NMRacqus.grpdly-NMRacqus.de*1e-6/2/NMRacqus.dw)*2*pi*grpdlycount));            %zeroshiftfun = exp(-i*((NMRacqus.grpdly+37e-6/2/NMRacqus.dw)*2*pi*grpdlycount));            zeroshiftfun = flipdim(zeroshiftfun,1);            zeroshiftfun = fftshift(zeroshiftfun,1);            Stemp = fft(Stemp,td/2,1);            Stemp = zeroshiftfun.*Stemp;            Stemp = ifft(Stemp,td/2,1);            %figure(1), clf, plot(t,real(Stemp)), return            Stemp = lbfunz.*Stemp;            %figure(1), clf, plot(k.z,real(Stemp),k.z,lbfunz*max(real(Stemp))), return            index = 1:tdim.z;            if nudim.z < tdim.z                index = .5*(tdim.z-nudim.z) + (1:nudim.z);                Stemp = Stemp(index);                k.z = k.z(index);                lbfunz = lbfunz(index);                %figure(1), clf, plot(k.z,real(Stemp),k.z,lbfunz*max(real(Stemp))), return            end            Itemp = fftshift(fft(Stemp,nudim.z));            %figure(1), clf, plot(abs(Itemp)), return            [zeroshiftfun,karray.y,karray.x] = ndgrid(zeroshiftfun,k.y,k.x);            [karray.z,karray.y,karray.x] = ndgrid(k.z,k.y,k.x);            lbfun1 = exp(-lb.^2*pi.^2*(karray.z.^2 + karray.y.^2 + karray.x.^2));            Stemp = fft(S,tdim.z,1);            Stemp = zeroshiftfun.*Stemp;            Stemp = ifft(Stemp,tdim.z,1);            Stemp = Stemp(index,:,:);            Stemp = Stemp.*lbfun1;            if nudim.z > tdim.z                Nzeros = nudim.z - tdim.z;                Stemp2 = zeros(nudim.z,tdim.y,tdim.x);                Stemp2(Nzeros/2+(1:tdim.z),:,:) = Stemp;                Stemp = Stemp2;            end            Stemp = fftshift(fft(ifftshift(Stemp,1),[],1),1);            if nudim.y > tdim.y                Nzeros = nudim.y - tdim.y;                Stemp2 = zeros(nudim.z,nudim.y,tdim.x);                Stemp2(:,Nzeros/2+(1:tdim.y),:) = Stemp;                Stemp = Stemp2;            end            Stemp = fftshift(fft(ifftshift(Stemp,2),[],2),2);            if nudim.x > tdim.x                Nzeros = nudim.x - tdim.x;                Stemp2 = zeros(nudim.z,nudim.y,nudim.x);                Stemp2(:,:,Nzeros/2+(1:tdim.x)) = Stemp;                Stemp = Stemp2;            end            I = fftshift(fft(ifftshift(Stemp,3),[],3),3);            clear Stemp Stemp2            %I = abs(I);            Imax = abs(I);            Imax(nudim.z/2+(-2:4),nudim.y/2+(0:2),nudim.x/2+(0:2)) = 0;            Imax = max(reshape(Imax,numel(Imax),1));            maxz = max(r.z)*1e3;            maxx = max(r.x)*1e3;            nx = nudim.x/2+1;            ny = nudim.y/2+1;            nz = nudim.z/2+1;            [Iplot.r,Iplot.g,Iplot.b] = fphase2rgb(angle(I));            Iplot.r = Iplot.r.*abs(I)/Imax;            Iplot.g = Iplot.g.*abs(I)/Imax;            Iplot.b = Iplot.b.*abs(I)/Imax;            Iplot.r = abs(I)/Imax; Iplot.g = Iplot.r; Iplot.b = Iplot.r;                        figure(2), clf                       axes('position',[.07 .1 .2 .9],'FontSize',fontsize)            C = zeros(nudim.z,nudim.x,3);            C(:,:,1) = squeeze(Iplot.r(:,ny,:));            C(:,:,2) = squeeze(Iplot.g(:,ny,:));            C(:,:,3) = squeeze(Iplot.b(:,ny,:));            image(r.x*1e3,r.z*1e3,C)            set(gca,'YDir','normal')            axis equal, axis tight            ylabel('\itz\rm / mm'), xlabel('\itx\rm / mm')            axes('position',[.28 .1 .2 .9],'FontSize',fontsize)            C = zeros(nudim.z,nudim.y,3);            C(:,:,1) = squeeze(Iplot.r(:,:,nx));            C(:,:,2) = squeeze(Iplot.g(:,:,nx));            C(:,:,3) = squeeze(Iplot.b(:,:,nx));            image(r.y*1e3,r.z*1e3,C)            set(gca,'YDir','normal','YTick',[])            axis equal, axis tight            xlabel('\ity\rm / mm')            Nslices = 4^2;            slices = round(nudim.z*linspace(0,1,Nslices+2)); slices([1 Nslices+2]) = [];            width = .5/sqrt(Nslices);            height = 11/8.5*.5/sqrt(Nslices);            nslice = 1;            for county = 1:sqrt(Nslices)                for countx = 1:sqrt(Nslices)                    axes('position',[1-countx*width .2+(county-1)*height 1.01*width 1.01*height])                    nz = slices(nslice);                    C = zeros(nudim.y,nudim.x,3);                    C(:,:,1) = squeeze(Iplot.r(nz,:,:));                    C(:,:,2) = squeeze(Iplot.g(nz,:,:));                    C(:,:,3) = squeeze(Iplot.b(nz,:,:));                    image(r.x*1e3,r.y*1e3,C)                    set(gca,'YDir','normal','YTick',[])                    axis tight, axis off                    nslice = nslice+1;                end            end                        delete([num2str(expno(nexp)) '/ReportFig.*'])            delete([num2str(expno(nexp)) '/acqu*sconv'])            delete([num2str(expno(nexp)) '/*Dat.mat'])            delete([num2str(expno(nexp)) '/*.jpg'])            set(gcf, 'PaperPosition', [0 0 11 8.5],'PaperSize', [11 8.5]);             eval(['print ' num2str(expno(nexp)) '/ReportFig -loose -dpdf'])            %eval(['save ' num2str(expno(nexp)) '/ImageDat I r'])                           % make nifti headear            h = mdm_nii_h_empty;            I_nii = flip(flip(shiftdim(abs(I),1),1),2);            sdim = size(I_nii);            h.pixdim(1+(1:length(sdim))) = sdim;            h.pixdim(2:4) = [resolution.x resolution.y resolution.z];            h.xyzt_units = 'SI';            % write nifti image and header            nii_fn = fullfile(DataDir,ExpNam{ndir},num2str(expno(nexp)),'pdata_mddmri','data.nii.gz');            msf_mkdir(fileparts(nii_fn))            mdm_nii_write(I_nii, nii_fn, h, 0);        end    end    cd ..endcd(wd)