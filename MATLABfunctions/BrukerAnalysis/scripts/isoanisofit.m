clear allwd = cd;DataDir = '/Users/daniel/NMRdata/AVII500/DT/';%DataDir = '/opt/topspin2/data/DT/nmr';cd(DataDir)ExpNam = {'isoaniso_test'}; expno = 75; expno = 83; expno = 107;signal = 'intensity';signal = 'area';FindAlpha = 0; alpha = 2;%bmax = 5e9;td1start = 2;cd(ExpNam{1})if exist('expno') == 0    GetExpnosendfor nexp = 1:length(expno)    eval(['load ' num2str(expno(nexp)) '/NMRacqus'])        if any(strcmp(NMRacqus.pulprog,{'DT_pgseisoaniso'})) == 1        eval(['load ' num2str(expno(nexp)) '/NMRacqu2s'])        eval(['load ' num2str(expno(nexp)) '/FitDat PP'])        fs = 20;        lw = 1;        clear FitDat        %fitpoints = td1start:(sqrt(NMRacqu2s.td)-1);        fitpoints = td1start:(length(PP.X)-1);        FitDat.fitpoints = fitpoints;                PP.sumpeaks = [2 3 4]; PP.sumpeaks = 1:PP.Npeaks; PP.Npeaks = 1;         PP.Apeak = sum(PP.Apeak(PP.sumpeaks,:),1);        PP.Ipeak = sum(PP.Ipeak(PP.sumpeaks,:),1);        for npeak = 1:PP.Npeaks            Ydat = reshape(PP.Ipeak(npeak,:),sqrt(NMRacqu2s.td),sqrt(NMRacqu2s.td));            if strcmp(signal,'area')==1                Ydat = reshape(PP.Apeak(npeak,:),sqrt(NMRacqu2s.td),sqrt(NMRacqu2s.td));            end            Xdat = PP.X;            %figure(1), clf, loglog(Xdat,Ydat(1,:),'o',Xdat,Ydat(:,1),'o'), return            %figure(1), clf, loglog(Xdat,Ydat,'o'), return            t1 = Xdat(fitpoints);            t2 = Xdat(fitpoints);            t1norm = mean(t1); t1 = t1/t1norm;            t2norm = mean(t2); t2 = t2/t2norm;            Nt1 = length(t1);            Nt2 = length(t2);            t1min = min(t1);            t1max = max(t1);            t2min = min(t2);            t2max = max(t2);            NR1 = 32;            NR2 = NR1;            Ns1 = min([8 Nt1]);                        Ns2 = Ns1;            %R1min = .5/t1max; R1max = 1/t1min;            %R1min = 1e-11*t1norm; R1max = 10e-9*t1norm;            R1min = .5/t1max; R1max = 10e-9*t1norm;                        R2min = R1min;            R2max = R1max;            R1 = logspace(log10(R1min),log10(R1max),NR1);            R2 = logspace(log10(R2min),log10(R2max),NR2);            [t1arrayt2,t2arrayt1] = ndgrid(t1,t2);            [R1arrayR2,R2arrayR1] = ndgrid(R1,R2);            [t1arrayR1,R1arrayt1] = ndgrid(t1,R1);            [t2arrayR2,R2arrayt2] = ndgrid(t2,R2);            K1 = exp(-R1arrayt1.*t1arrayR1);            K2 = exp(-R2arrayt2.*t2arrayR2);            [U1,S1,V1] = svd(K1);            [U2,S2,V2] = svd(K2);            %figure(1), clf, semilogy(1:min([Nt1 NR1]),diag(S1),'-o',1:min([Nt2 NR2]),diag(S2),'-s'), return            U1comp = U1(1:Nt1,1:Ns1);            S1comp = S1(1:Ns1,1:Ns1);            V1comp = V1(1:NR1,1:Ns1);            U2comp = U2(1:Nt2,1:Ns2);            S2comp = S2(1:Ns2,1:Ns2);            V2comp = V2(1:NR2,1:Ns2);            K1comp = S1comp*V1comp';            K2comp = S2comp*V2comp';            K0comp = kron(K2comp,K1comp);            Kcomp = K0comp*K0comp';            St1t2array = Ydat(fitpoints,fitpoints);            St1t2array = St1t2array/max(max(St1t2array));            %figure(1), clf, surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),St1t2array), view(0,90), shading('flat'), return            %%            figure(1), clf            semilogy(t1arrayt2(:,1)*t1norm,St1t2array(:,1),'o',t2arrayt1(1,:)*t2norm,St1t2array(1,:),'o')            %semilogy(t2arrayt1*t1norm,St1t2array,'o')            set(gca,'YLim',[1e-3 1],'XLim',[0 max(Xdat)])            %return            Dat1D.biso = t1arrayt2(:,1)*t1norm;            Dat1D.Iiso = St1t2array(:,1);            Dat1D.b = t2arrayt1(1,:)'*t2norm;            Dat1D.I = St1t2array(1,:)';            eval(['save ' num2str(expno(nexp)) '/Dat1D Dat1D'])                        Dat2D.biso = t1arrayt2*t1norm;            Dat2D.b = t2arrayt1*t2norm;            Dat2D.I =  St1t2array;            eval(['save ' num2str(expno(nexp)) '/Dat2D Dat2D'])                        %%            Scomp =  U1comp'*St1t2array*U2comp;            Suncomp =  U1comp*Scomp*U2comp';            %figure(1), clf, surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),Suncomp), view(0,90), shading('flat'), return            %figure(1), clf, surf(log10(t1arrayt2),log10(t2arrayt1),St1t2array-Suncomp), view(0,90), shading('flat'), return            scomp = reshape(Scomp,Ns1*Ns2,1);            %figure(1), clf, plot(1:Ns1*Ns2,scomp,'-o'), return            pcompfit = Kcomp\scomp;            scompfit = Kcomp*pcompfit;            Pfit = reshape(K0comp'*pcompfit,NR1,NR2);            Sfit = K1*Pfit*K2';            chimin = sum(sum(sqrt((St1t2array-Sfit).^2)))/Nt1/Nt2;            fontsize = 12;                        if FindAlpha                alphavector = [.1 1 1.5 2 2.5 3];                Ns1vector = [7 8 9 10 11 12];                [alphavector,Ns1vector] = ndgrid(alphavector,Ns1vector);                alphavector = reshape(alphavector,numel(alphavector),1);                                Ns1vector = reshape(Ns1vector,numel(Ns1vector),1);                                Nalpha = length(alphavector);                Pfitarray = zeros(NR1,NR2,Nalpha);                chivector = zeros(Nalpha);                figure(3),clf                Nsubplot = ceil(sqrt(Nalpha));                for nalpha = 1:Nalpha                    alpha = alphavector(nalpha);                    Ns1 = min([Ns1vector(nalpha) Nt1]);                                Ns2 = Ns1;                    U1comp = U1(1:Nt1,1:Ns1);                    S1comp = S1(1:Ns1,1:Ns1);                    V1comp = V1(1:NR1,1:Ns1);                    U2comp = U2(1:Nt2,1:Ns2);                    S2comp = S2(1:Ns2,1:Ns2);                    V2comp = V2(1:NR2,1:Ns2);                    K1comp = S1comp*V1comp';                    K2comp = S2comp*V2comp';                    K0comp = kron(K2comp,K1comp);                    Kcomp = K0comp*K0comp';                    Scomp =  U1comp'*St1t2array*U2comp;                    Suncomp =  U1comp*Scomp*U2comp';                    %figure(1), clf, surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),Suncomp), view(0,90), shading('flat'), return                    %figure(1), clf, surf(log10(t1arrayt2),log10(t2arrayt1),St1t2array-Suncomp), view(0,90), shading('flat'), return                    scomp = reshape(Scomp,Ns1*Ns2,1);                    %figure(1), clf, plot(1:Ns1*Ns2,scomp,'-o'), return                    options = optimset('MaxIter',1e4,'LargeScale','off');                    %pcompfit = lsqlin(Kcomp,scomp,-K0comp',eps*ones(NR1*NR2,1),[],[],-ones(Ns1*Ns2,1),ones(Ns1*Ns2,1),[],options);                    pcompfit = lsqlin([Kcomp; alpha*K0comp'],[scomp; zeros(NR1*NR2,1)],-K0comp',eps*ones(NR1*NR2,1),[],[],-ones(Ns1*Ns2,1),ones(Ns1*Ns2,1),[],options);                    scompfit = Kcomp*pcompfit;                    Pfit = reshape(K0comp'*pcompfit,NR1,NR2);                    Sfit = K1*Pfit*K2';                    chi = sum(sum(sqrt((St1t2array-Sfit).^2)))/Nt1/Nt2;                                        subplot(Nsubplot,Nsubplot,nalpha)                    Pplot = Pfit;                    Pplot = Pplot/max(reshape(Pplot,numel(Pplot),1));                    Ythresh = 0.01;                    Pplot(Pplot<Ythresh) = Ythresh;                    Pplot = log10(Pplot);                    surf(log10(R1arrayR2/t1norm),log10(R2arrayR1/t2norm),Pplot)                    view(0,90), shading('flat'), axis('tight'), axis('square'), axis off                    %xlabel('log(D_{iso} / m^2s^-^1)','FontSize',fontsize), ylabel('log(D / m^2s^-^1)','FontSize',fontsize), zlabel('probability','FontSize',fontsize)                    %title(['\alpha=' num2str(alpha,2) ' Ns1=' num2str(Ns1) ' \chi=' num2str(chi,2) ])                    title([num2str(alpha,2) ' ' num2str(Ns1) ' ' num2str(chi,2)])                    pause(1)                                    end            else                options = optimset('MaxIter',1e4,'LargeScale','off');                %pcompfit = lsqlin(Kcomp,scomp,-K0comp',eps*ones(NR1*NR2,1),[],[],-ones(Ns1*Ns2,1),ones(Ns1*Ns2,1),[],options);                pcompfit = lsqlin([Kcomp; alpha*K0comp'],[scomp; zeros(NR1*NR2,1)],-K0comp',eps*ones(NR1*NR2,1),[],[],-ones(Ns1*Ns2,1),ones(Ns1*Ns2,1),[],options);                scompfit = Kcomp*pcompfit;                Pfit = reshape(K0comp'*pcompfit,NR1,NR2);                Sfit = K1*Pfit*K2';                chi = sum(sum(sqrt((St1t2array-Sfit).^2)))/Nt1/Nt2;                %%                figure(2), clf                colormap('hot')                subplot(2,2,1)                %surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),St1t2array)                surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),real(log10(St1t2array)))                view(0,90), shading('flat'), axis('tight'), axis('square')                %plot3(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),log10(St1t2array),'-o')                %plot3(t1arrayt2*t1norm,t2arrayt1*t2norm,log10(St1t2array),'-o')                %view(70,30), shading('flat'), axis('tight')                set(gca,'ZLim',[-3 0])                xlabel('log(b_{iso} / m^-^2s)','FontSize',fontsize), ylabel('log(b / m^-^2s)','FontSize',fontsize), zlabel('signal','FontSize',fontsize)                title(['expno = ' num2str(expno(nexp)) ' peakno = ' num2str(npeak)],'FontSize',fontsize)                subplot(2,2,2)                surf(log10(t1arrayt2*t1norm),log10(t2arrayt1*t2norm),St1t2array-Sfit)                view(70,30), shading('flat'), axis('tight')                xlabel('log(b_{iso} / m^-^2s)','FontSize',fontsize), ylabel('log(b / m^-^2s)','FontSize',fontsize), zlabel('residual','FontSize',fontsize)                title(['\chi = ' num2str(chi,2) ' (' num2str(chimin,2) ')'],'FontSize',fontsize)                subplot(2,2,3)                plot(1:Ns1*Ns2,scomp,'o',1:Ns1*Ns2,scompfit,'-')                ylabel('index','FontSize',fontsize), ylabel('compressed signal','FontSize',fontsize)                subplot(2,2,4)                Pplot = Pfit;                Pplot = Pplot/max(reshape(Pplot,numel(Pplot),1));                Ythresh = 0.2;                Pplot(Pplot<Ythresh) = Ythresh;                Pplot = log10(Pplot);                surf(log10(R1arrayR2/t1norm),log10(R2arrayR1/t2norm),Pfit)                %surf(log10(R1arrayR2/t1norm),log10(R2arrayR1/t2norm),Pplot)                view(0,90), shading('flat'), axis('tight'), axis('square')                xlabel('log(D_{iso} / m^2s^-^1)','FontSize',fontsize), ylabel('log(D / m^2s^-^1)','FontSize',fontsize), zlabel('probability','FontSize',fontsize)                pause(1)                %%                            end        end        delete([num2str(expno(nexp)) '/ReportFig.*'])        eval(['print -depsc -loose ' num2str(expno(nexp)) '/ReportFig'])    endend