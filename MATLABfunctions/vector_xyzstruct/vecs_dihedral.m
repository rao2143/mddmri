function phi = vecs_dihedral(r1,r2,r3,r4)r12 = vecs_dif(r1,r2); % vector from r1 to r2r23 = vecs_dif(r2,r3);r34 = vecs_dif(r3,r4);bf.z = vecs_norm(r23); % z-axis in bond framebf.y = vecs_norm(vecs_crossprod(r12,r23)); % y-axis in bond frame defined by normal vector in 1-2-3 planebf.x = vecs_crossprod(bf.y,bf.z);r34_bf = vecs_proj(r34,bf); % project r34 vector to bond framephi = angle(exp(1i*(atan2(r34_bf.y,r34_bf.x) - pi))) + pi; % dihedral angle% r2_bf = vecs_dif(r23_bf,r23_bf);% r1_bf = vecs_sum(r2_bf,vecs_invert(r12_bf));% r3_bf = vecs_sum(r2_bf,r23_bf);% r4_bf = vecs_sum(r3_bf,r34_bf);% % figure(1), clf% for idx_t = 1:1%     r1 = vecs_subsample(r1_bf,{idx_t});%     r2 = vecs_subsample(r2_bf,{idx_t});%     r3 = vecs_subsample(r3_bf,{idx_t});%     r4 = vecs_subsample(r4_bf,{idx_t});% % plot3([r1.x r2.x r3.x r4.x],...%     [r1.y r2.y r3.y r4.y],...%     [r1.z r2.z r3.z r4.z],...%     '-')% axis square% axis(.2*[-1 1 -1 1 -1 1])% xlabel('x'), ylabel('y'), zlabel('z')% view(-90,90)% hold on% pause(.1)% end